<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Flash-X configuration &mdash; Flash-X 0.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Driver Unit" href="driver.html" />
    <link rel="prev" title="Overview of Flash-X architecture" href="arch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Flash-X
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="disclaimers.html">Current Status and Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.html">Overview of Flash-X architecture</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Flash-X configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#config-file-keywords-and-syntax">Config file Keywords and syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-setup-tool">The Setup Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-arguments">Setup Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-shortcuts">Using Shortcuts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-variables-and-preprocessing-config-files">Setup Variables and Preprocessing <code class="docutils literal notranslate"><span class="pre">Config</span></code> Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-site-specific-makefile">Creating a Site-specific <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#files-created-during-the-setup-process">Files Created During the <code class="docutils literal notranslate"><span class="pre">setup</span></code> Process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#informational-files">Informational files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-generated-by-the-setup-call">Code generated by the <code class="docutils literal notranslate"><span class="pre">setup</span></code> call</a></li>
<li class="toctree-l2"><a class="reference internal" href="#makefiles-generated-by-setup">Makefiles generated by <code class="docutils literal notranslate"><span class="pre">setup</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-a-hybrid-mpi-openmp-flashx-application">Setup a hybrid MPI+|openmp| Flash-X application</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="driver.html">Driver Unit</a></li>
<li class="toctree-l1"><a class="reference internal" href="infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="physics.html">Physics Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor.html">Monitor Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_section.html">Developer’s Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Flash-X</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">The Flash-X configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/setup.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-flashx-configuration">
<h1>The Flash-X configuration<a class="headerlink" href="#the-flashx-configuration" title="Permalink to this heading"></a></h1>
<p>The configuration toolchain effectively implements the Flash-X
software architecture. The encapsulation and inheritance of the code
is implemented and enforced by this tool. It relies upon Flash-X’s
domain specific configuration language <em>(DSCL)</em> that encodes
meta-information about the components in the accompanying
<em>Config</em> files. A Config file is unique to a unix directory and has
all the meta-information about files in that directory. It can also
include information about how to traverse subdirectories of the
corresponding component. The Config files are parsed by the <em>setup</em>
tool.</p>
<p>Config files come in two syntactic flavors: static text and
python. In static mode, configuration keywords are listed as lines in
a plain text file. This mode is the most readable and intuitive of the
two, but it lacks flexibility. The python mode has been introduced to
circumvent this inflexibility by allowing the configuration file author
to specify the configuration directives as a function of the setup
variables with a python procedure. This allows the content of each
directive and the number of directives in total to be amenable to
general programming.</p>
<p>The rule the setup script uses for deciding which flavor of
configuration file it’s dealing with is simple. Python configuration
files have as their first line <code class="docutils literal notranslate"><span class="pre">##python:genLines</span></code>. If the first line
does not match this string, then static mode is assumed and each line of
the file is interpreted verbatim as a directive.</p>
<p>If python mode is triggered, then the entire file is considered as valid
python source code (as if it were a .py). From this python code, a
function of the form <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">genLines(setupvars)</span></code> is located and executed
to generate the configuration directives as an array (or any iterable
collection) of strings. The sole argument to genLines is a dictionary
that maps setup variable names to their corresponding string values.</p>
<p>As an example, here is a configuration file in python mode that
registers runtime parameters named indexed_parameter_x where x ranges
from 1 to NP and NP is a setup line variable.</p>
<div class="fcodeseg docutils container">
<p>##python:genLines</p>
<p># We define genLines as a generator with the very friendly “yield”
syntax. # Alternatively, we could have genLines return an array of
strings or even # one huge multiline string. def genLines(setupvars):
# emit some directives that dont depend on any setup variables yield
“”” REQUIRES Driver REQUIRES physics/Hydro REQUIRES physics/Eos “”” #
read a setup variable value from the dictionary np =
int(setupvars(“NP”)) # must be converted from a string # loop from 0
to np-1 for x in xrange(np): yield “PARAMETER indexed_parameter_%d
REAL 0.” % (x+1)</p>
</div>
<p>When setting up a problem with NP=5 on the setup command line, the
following directives will be processed:</p>
<div class="fcodeseg docutils container">
<p>REQUIRES Driver
REQUIRES physics/Hydro
REQUIRES physics/Eos
PARAMETER  indexed_parameter_1 REAL 0.
PARAMETER indexed_parameter_2 REAL 0.
PARAMETER indexed_parameter_3 REAL 0.
PARAMETER indexed_parameter_4  REAL 0.
PARAMETER indexed_parameter_5 REAL 0.</p>
</div>
<section id="config-file-keywords-and-syntax">
<span id="sec-dscl-keywords"></span><h2>Config file Keywords and syntax<a class="headerlink" href="#config-file-keywords-and-syntax" title="Permalink to this heading"></a></h2>
<p>The syntax of the configuration directives is described here.
Arbitrarily many spaces and/or tabs may be used, but all keywords must
be in uppercase. Lines not matching an ad missible pattern will raise an
error when running setup. The syntax of DSCL includes two types of
keywords. The directive keywords define actions to be taken by the
setup tool, while the non directive keywords encode information about
the directives. The non directive keywords are associated with
specific directives keyworks.</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">comment</span></code></div>
<div class="line">A comment. Can appear as a separate line or at the end of a line.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code> <em>sub-component</em></div>
<div class="line">Any component can designate one component (which is effectively a
subdirectory)  to be the  “default”, with this keyword. If no specific sub-component is
 selected by the application, the designated default implementation
 gets included.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">EXCLUSIVE</span></code> <em>component…</em></div>
<div class="line">Specifies a list of components that cannot be included
together.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">CONFLICTS</span></code> <em>unit1[/sub-unit[/component…]]</em> …</div>
<div class="line">Specifies that the current component is not compatible with</div>
</div>
<dl class="simple">
<dt>the list of components that follow. <code class="docutils literal notranslate"><span class="pre">setup</span></code> issues an error if</dt><dd><p>the user attempts a conflicting configuration.</p>
</dd>
</dl>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> <em>unit[/sub-unit[/component…]] [</em> <code class="docutils literal notranslate"><span class="pre">OR</span></code>
<em>unit[/sub-unit…]]…</em></div>
<div class="line">Specifies a component that is required. The component can be</div>
</div>
<p>specified with partially specified or full specified path. If
partial path is specified then full path is generated by
following the “DEFAULT” options of the subcomponents.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">REQUESTS</span></code> <em>unit[/sub-unit[/component…]]</em></div>
<div class="line">Is similar to REQUIRES except that it is a soft</div>
</div>
</li>
</ul>
<blockquote>
<div><p>dependency. It can be overridden through either a commandline
specification or through dependencies specified in higher priority
locations in the source tree.</p>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">VARIANTS</span></code> <em>variantname variantname …</em></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">|</span></a>Indicates that multiple alternative</p>
</li>
</ul>
<blockquote>
<div><p>implemetations of a component are to be included in the setup where
each implementation gets its interface and routine/function name
appended with the corresponding variant name. For example, one may
want to use both CPU and GPU to  compute. A component that has valid
implementations for both can specify variants as shown below.</p>
<blockquote>
<div><div class="codeseg docutils container">
<p>VARIANTS CPU GPU</p>
</div>
</div></blockquote>
<p>Then if the setup options specify inclusion of both implementations,  the
names of the relevant files and function/subroutine interfaces are
modified to have unique names. If, on the other hand, only one of the
implementations is to be included, the default is Null and all the
names remain unmodified.</p>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SUGGEST</span></code> <em>component component  …</em></div>
<div class="line">Unlike <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code>, this keyword suggests that the current component be
used along with one of the specified component. The setup script will
print details of the suggestions which have been ignored. This is
useful in catching inadvertently omitted code components before the run
starts, thus avoiding a waste of computing resources.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">UNOFFICIAL</span></code></div>
<div class="line">This keyword suggests that the current component is
not fully supported. The setup script will abort if a component
with this keyword in included. It can be overridden as follows:</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="codeseg docutils container">
<p>–with-unofficial= <em>component</em></p>
</div>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PARAMETER</span></code> <em>name type [``CONSTANT``] default</em> [<em>range-spec</em>]</div>
<div class="line">Specifies a runtime parameter. Parameter names are unique up to 20
characters and may not contain spaces. Admissible types include
<code class="docutils literal notranslate"><span class="pre">REAL</span></code>, <code class="docutils literal notranslate"><span class="pre">INTEGER</span></code>, <code class="docutils literal notranslate"><span class="pre">STRING</span></code>, and <code class="docutils literal notranslate"><span class="pre">BOOLEAN</span></code>. Default values
for <code class="docutils literal notranslate"><span class="pre">REAL</span></code> and <code class="docutils literal notranslate"><span class="pre">INTEGER</span></code> parameters must be valid numbers, or
the compilation will fail. Default <code class="docutils literal notranslate"><span class="pre">STRING</span></code> values must be
enclosed in double quotes (<code class="docutils literal notranslate"><span class="pre">&quot;</span></code>). Default <code class="docutils literal notranslate"><span class="pre">BOOLEAN</span></code> values must
be <code class="docutils literal notranslate"><span class="pre">.true.</span></code> or <code class="docutils literal notranslate"><span class="pre">.false.</span></code> to avoid compilation errors. Once
defined, runtime parameters are available to the entire code.
Optionally, any parameter may be specified with the <code class="docutils literal notranslate"><span class="pre">CONSTANT</span></code>
attribute (<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">PARAMETER</span> <span class="pre">foo</span> <span class="pre">REAL</span> <span class="pre">CONSTANT</span> <span class="pre">2.2</span></code>). If a user
attempts to set a constant parameter via the runtime parameter
file, an error will occur.</div>
</div>
<p>The range specification is optional and can be used to specify valid
ranges for the parameters. The range specification is allowed only
for <code class="docutils literal notranslate"><span class="pre">REAL,</span> <span class="pre">INTEGER,</span> <span class="pre">STRING</span></code> variables and must be enclosed in ’[]’.</p>
<p>For a <code class="docutils literal notranslate"><span class="pre">STRING</span></code> variable, the range specification is a
comma-separated list of strings (enclosed in quotes). For a
<code class="docutils literal notranslate"><span class="pre">INTEGER,</span> <span class="pre">REAL</span></code> variable, the range specification is a
comma-separated list of (closed) intervals specified by
<code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">...</span> <span class="pre">max</span></code>, where min and max are the end points of the
interval. If min or max is omitted, it is assumed to be
<span class="math notranslate nohighlight">\(-\infty\)</span> and <span class="math notranslate nohighlight">\(+\infty\)</span> respectively. Finally <code class="docutils literal notranslate"><span class="pre">val</span></code> is
a shortcut for <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">...</span> <span class="pre">val</span></code>. For example</p>
<div class="codeseg docutils container">
<p>PARAMETER pres REAL 1.0 [ 0.1 … 9.9, 25.0 … ] PARAMETER coords
STRING “polar” [“polar”,”cylindrical”,”2d”,”3d”]</p>
</div>
<p>indicates that <code class="docutils literal notranslate"><span class="pre">pres</span></code> is a REAL variable which is allowed to take
values between 0.1 and 9.9 or above 25.0. Similarly <code class="docutils literal notranslate"><span class="pre">coords</span></code> is a
string variable which can take one of the four specified values.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">D</span></code> <em>parameter-name</em> <em>comment</em></div>
<div class="line">Any line in a <code class="docutils literal notranslate"><span class="pre">Config</span></code> file is considered a parameter comment
line if it begins with the token <code class="docutils literal notranslate"><span class="pre">D</span></code>. The first token after the
comment line is taken to be the parameter name. The remaining
tokens are taken to be a description of the parameter’s purpose. A
token is delineated by one or more white spaces. For example,</div>
</div>
<div class="codeseg docutils container">
<p>D SOME_PARAMETER The purpose of this parameter is whatever</p>
</div>
<p>If the parameter comment requires additional lines, the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> is used
to indicate continuation lines. For example,</p>
<div class="codeseg docutils container">
<p>D SOME_PARAMETER The purpose of this parameter is whatever D &amp;
This is a second line of description</p>
</div>
<p>You can also use this to describe other variables, fluxes, species,
etc. For example, to describe a species called “xyz”, create a
comment for the parameter “xyz_species”. In general the name should
be followed by an underscore and then by the lower case name of the
keyword used to define the name.</p>
<p>Parameter comment lines are special because they are used by
to build a formatted list of commented runtime parameters
for a particular problem. This information is generated in the file
<code class="docutils literal notranslate"><span class="pre">setup_params</span></code> in the <code class="docutils literal notranslate"><span class="pre">object</span></code> directory.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code> <em>name</em> <em>[``TYPE:`` vartype]</em> <em>[eosmap-spec]</em></div>
<div class="line">Registers variable with the framework with name <em>name</em> and a
variable type defined by <em>vartype</em>. The <code class="docutils literal notranslate"><span class="pre">setup</span></code> script collects
variables from all the included units, and creates a comprehensive
list with no duplications. It then assigns defined constants to
each variable and calculates the amount of storage required in the
data structures for storing these variables. The defined constants
and the calculated sizes are written to the file <code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code>.</div>
</div>
<p>The possible types for <em>vartype</em> are as follows:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PER_VOLUME</span></code></div>
<div class="line">This solution variable is represented in <strong>conserved</strong> form,
<em>i.e.</em>, it represents the density of a conserved extensive
quantity. The prime example is a variable directly representing
mass density. Energy densities, momentum densities, and partial
mass densities would be other examples (but these quantities are
usually represented in <code class="docutils literal notranslate"><span class="pre">PER_MASS</span></code> form instead).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PER_MASS</span></code></div>
<div class="line">This solution variable is represented in <strong>mass-specific</strong> form,
<em>i.e.</em>, it represents quantities whose nature is
<span class="math notranslate nohighlight">\(\hbox{extensive quantity}\,\mathop{\mathrm{per}}\,\hbox{mass unit}\)</span>.
Examples are specific energies, velocities of material (since
they are equal to momentum per mass unit), and abundances or
mass fractions (partial density divided by density).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">GENERIC</span></code></div>
<div class="line">This is the default <em>vartype</em> and need not be specified. This
type should be used for any variables that do not clearly belong
to one of the previous two categories.</div>
</div>
</li>
</ul>
<p>In the current version of the code, the <code class="docutils literal notranslate"><span class="pre">TYPE</span></code> attribute is only
used to determine which variables should be converted to conservative
form for certain <code class="docutils literal notranslate"><span class="pre">Grid</span></code> operations that may require interpolation
(<em>i.e.</em>, prolongation, guardcell filling, and restriction) when one
of the runtime parameters <code class="docutils literal notranslate"><span class="pre">Grid/convertToConsvdForMeshCalls</span></code> or
<code class="docutils literal notranslate"><span class="pre">Grid/convertToConsvdInMeshInterp</span></code> is set <code class="docutils literal notranslate"><span class="pre">true</span></code>. Only variables
of type <code class="docutils literal notranslate"><span class="pre">PER_MASS</span></code> are converted: values are multiplied
cell-by-cell with the value of the <code class="docutils literal notranslate"><span class="pre">&quot;dens&quot;</span></code> variable, and potential
interpolation results are converted back by cell-by-cell division by
<code class="docutils literal notranslate"><span class="pre">&quot;dens&quot;</span></code> values after interpolation.</p>
<p>Note that therefore</p>
<ul>
<li><p>variable types are irrelevant for uniform grids,</p></li>
<li><p>variable types are irrelevant if neither
<code class="docutils literal notranslate"><span class="pre">Grid/convertToConsvdForMeshCalls</span></code> nor
<code class="docutils literal notranslate"><span class="pre">Grid/convertToConsvdInMeshInterp</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, and</p></li>
<li><p>variable types (and conversion to and from conserved form) only
take effect if a</p>
<div class="codeseg docutils container">
<p>VARIABLE dens …</p>
</div>
<p>exists.</p>
</li>
</ul>
<p>An <em>eosmap-spec</em> has the syntax <em>``EOSMAP:`` eos-role</em> <span class="math notranslate nohighlight">\(|\)</span> <em>(
[``EOSMAPIN:`` eos-role] [``EOSMAPOUT:`` eos-role ])</em>, where
<em>eos-role</em> stands for a <strong>role</strong> as defined in <code class="docutils literal notranslate"><span class="pre">Eos_map.h</span></code>. These
roles are used within implementations of the
<code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_wrapped</span></code> interface, via the subroutines
<code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_getData</span></code> and <code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_putData</span></code>, to map
variables from <code class="docutils literal notranslate"><span class="pre">Grid</span></code> data structures to the <code class="docutils literal notranslate"><span class="pre">eosData</span></code> array that
<code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos</span></code> understands, and back. For example,</p>
<div class="codeseg docutils container">
<p>VARIABLE eint TYPE: PER_MASS EOSMAPIN: EINT</p>
</div>
<p>means that within <code class="docutils literal notranslate"><span class="pre">Eos_wrapped</span></code>, the <code class="docutils literal notranslate"><span class="pre">EINT_VAR</span></code> component of
<code class="docutils literal notranslate"><span class="pre">unk</span></code> will be treated as the grid variable in the “internal energy”
role for the purpose of constructing input to <code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos</span></code>,
and</p>
<div class="codeseg docutils container">
<p>VARIABLE gamc EOSMAPOUT: GAMC</p>
</div>
<p>means that within <code class="docutils literal notranslate"><span class="pre">Eos_wrapped</span></code>, the <code class="docutils literal notranslate"><span class="pre">GAMC_VAR</span></code> component of
<code class="docutils literal notranslate"><span class="pre">unk</span></code> will be treated as the grid variable in the <code class="docutils literal notranslate"><span class="pre">EOSMAP_GAMC</span></code>
role for the purpose of returning results from calling
<code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos</span></code> to the grid. The specification</p>
<div class="codeseg docutils container">
<p>VARIABLE pres EOSMAP: PRES</p>
</div>
<p>has the same effect as</p>
<div class="codeseg docutils container">
<p>VARIABLE pres EOSMAPIN: PRES EOSMAPOUT: PRES</p>
</div>
<p>Note that not all roles defined in <code class="docutils literal notranslate"><span class="pre">Eos_map.h</span></code> are necessarily
meaningful or actually used in a given <code class="docutils literal notranslate"><span class="pre">Eos</span></code> implementation. An
<em>eosmap-spec</em> for a <code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code> is only used in an
<code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_wrapped</span></code> invocation when the optional
<code class="docutils literal notranslate"><span class="pre">gridDataStruct</span></code> argument is absent or has a value of <code class="docutils literal notranslate"><span class="pre">CENTER</span></code>.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">FACEVAR</span></code> <em>name</em> <em>[eosmap-spec]</em></div>
<div class="line">This keyword has the same meaning for face-centered variables, that
<code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code> does for cell-centered variables. It allocates space
in the grid data structure that contains face-centered physical
variables for “name”.</div>
</div>
<p>For <em>eosmap-spec</em>, see above under <code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code>. An <em>eosmap-spec</em> for
<code class="docutils literal notranslate"><span class="pre">FACEVAR</span></code> is only used when <code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_wrapped</span></code> is called
with an optional <code class="docutils literal notranslate"><span class="pre">gridDataStruct</span></code> argument of <code class="docutils literal notranslate"><span class="pre">FACEX</span></code>, <code class="docutils literal notranslate"><span class="pre">FACEY</span></code>,
or <code class="docutils literal notranslate"><span class="pre">FACEZ</span></code>.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">FLUX</span></code> <em>name</em></div>
<div class="line">Registers flux variable <em>name</em> with the framework. When using an
adaptive mesh, flux conservation is needed at fine-coarse
boundaries. Each state variable that needs flux conservation is
made known to the framework through this keyword.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">MASS_SCALAR</span></code> <em>name</em> <em>[RENORM: group-name]</em> <em>[eosmap-spec]</em></div>
<div class="line">If a quantity is defined with keyword MASS_SCALAR, space is created
for it in the grid “unk” data structure. It is treated like any
other variable by <code class="docutils literal notranslate"><span class="pre">PARAMESH</span></code>, but the hydrodynamic unit treats it
differently. It is advected, but other physical characteristics
don’t apply to it. If the optional “RENORM” is given, this
mass-scalar will be added to the renormalization group of the
accompanying group name. The hydrodynamic solver will renormalize
all mass-scalars in a given group, ensuring that all variables in
that group will sum to 1 within an individual cell. See</div>
</div>
<p>For <em>eosmap-spec</em>, see above under <code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code>. An <em>eosmap-spec</em> for
a <code class="docutils literal notranslate"><span class="pre">MASS_SCALAR</span></code> may be used in an <code class="docutils literal notranslate"><span class="pre">physics/Eos/Eos_wrapped</span></code>
invocation when the optional <code class="docutils literal notranslate"><span class="pre">gridDataStruct</span></code> argument is absent or
has a value of <code class="docutils literal notranslate"><span class="pre">CENTER</span></code>.</p>
<div class="flashtip docutils container">
<p>It is inadvisable to name variables, species, and mass scalars
with the same prefix, as post-processing routines have difficulty
deciphering the type of data from the output files. For example,
don’t create a variable “temp” to hold temperature and a mass
scalar “temp” indicating a temporary variable. Although the
<code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code> file can distinguish between these two types of
variables, many plotting routines cannot.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PARTICLETYPE</span></code> <em>particle-type</em> <code class="docutils literal notranslate"><span class="pre">INITMETHOD</span></code>
<em>initialization-method</em> <code class="docutils literal notranslate"><span class="pre">MAPMETHOD</span></code> <em>map-method</em> <code class="docutils literal notranslate"><span class="pre">ADVMETHOD</span></code>
<em>time-advance-method</em></div>
<div class="line">This keyword associates a <strong>particle type</strong> with mapping and
initialization sub-units of <code class="docutils literal notranslate"><span class="pre">Particles</span></code> unit to operate on this
particle type during the simulation. Here, <em>map-method</em> describes
the method used to map the particle properties to and from the mesh
(see ), <em>initialization-method</em> describes the method used to
distribute the particles at initialization, and
<em>time-advance-method</em> describes the method used to advance the
associated particle type in time. This
keyword has been introduced to facilitate inclusion of multiple
particle types in the same simulation. It imposes certain
requirements on the use of the <code class="docutils literal notranslate"><span class="pre">ParticlesMapping</span></code> and
<code class="docutils literal notranslate"><span class="pre">ParticlesInitialization</span></code> subunits. Particles (of any type,
whether called <code class="docutils literal notranslate"><span class="pre">passive</span></code> or anything else) do not have default
methods for initialization, mapping, or time integration, so a
<code class="docutils literal notranslate"><span class="pre">PARTICLETYPE</span></code> directive in a <code class="docutils literal notranslate"><span class="pre">Config</span></code> file (or an equivalent
<code class="docutils literal notranslate"><span class="pre">-particlemethods=</span></code> setup option, see ) is the only way to
specify the appropriate implementations of the <code class="docutils literal notranslate"><span class="pre">Particles</span></code>
subunits to be used. The declaration should be accompanied by
appropriate “REQUESTS” or “REQUIRES” directives to specify the
paths of the appropriate subunit implementation directories to be
included. For clarity, our technique has been to include this
information in the simulation directory <code class="docutils literal notranslate"><span class="pre">Config</span></code> files only. All
the currently available mapping and initialization methods have a
corresponding identifier in the form of preprocessor definition in
<code class="docutils literal notranslate"><span class="pre">Particles.h</span></code>. The user may select any <em>particle-type</em> name, but
the <em>map-method</em>, <em>initialization-method</em> and <em>time-advance-method</em>
must correspond to existing identifiers defined in <code class="docutils literal notranslate"><span class="pre">Particles.h</span></code>.
This is necessary to navigate the data structure that stores the
particle type and its associated mapping and initialization
methods. Users desirous of adding new methods for mapping or
initialization should also update the <code class="docutils literal notranslate"><span class="pre">Particles.h</span></code> file with
additional identifiers and their preprocessor definitions. Note, it
is possible to use the same methods for different particle types,
but each particle type name must only appear once. Finally, the
Simulations <code class="docutils literal notranslate"><span class="pre">Config</span></code> file is also expected to request appropriate
components of mapping and initialization subunits using the
keyword <code class="docutils literal notranslate"><span class="pre">REQUESTS</span></code>, since the corresponding Config files do not
specify a default component to include. For example, to
include <code class="docutils literal notranslate"><span class="pre">passive</span></code> particle types with <code class="docutils literal notranslate"><span class="pre">Quadratic</span></code> mapping,
<code class="docutils literal notranslate"><span class="pre">Lattice</span></code> initialization,and <code class="docutils literal notranslate"><span class="pre">Euler</span></code> for advancing in time the
following code segment should appear in the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file of the
<code class="docutils literal notranslate"><span class="pre">Simulations</span></code> directory.</div>
</div>
<div class="codeseg docutils container">
<p>PARTICLETYPE passive INITMETHOD lattice MAPMETHOD quadratic
ADVMETHOD Euler REQUIRES Particles/ParticlesMain REQUESTS
Particles/ParticlesMain/passive/Euler REQUESTS
Particles/ParticlesMapping/Quadratic REQUESTS
Particles/ParticlesInitialization/Lattice</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PARTICLEPROP</span></code> <em>name</em> <em>type</em></div>
<div class="line">This keyword indicates that the particles data structure will
allocate space for a sub-variable “NAME_PART_PROP.” For example if
the Config file contains</div>
</div>
<div class="codeseg docutils container">
<p>PARTICLEPROP dens</p>
</div>
<p>then the code can directly access this property as</p>
<div class="codeseg docutils container">
<p>particles(DENS_PART_PROP,1:localNumParticles) = densInitial</p>
</div>
<p><em>type</em> may be REAL or INT, however INT is presently unused. See for
more information and examples.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PARTICLEMAP</span></code> TO <em>partname</em> FROM <em>vartype</em> <em>varname</em></div>
<div class="line">This keyword maps the value of the particle property <em>partname</em> to
the variable <em>varname</em>. <em>vartype</em> can take the values VARIABLE,
MASS_SCALAR, SPECIES, FACEX, FACEY, FACEZ, or one of SCRATCH types
(SCRATCHVAR/ SCRATCHCENTERVAR, SCRATCHFACEXVAR. SCRATCHFACEYVAR,
SCRATCHFACEZVAR) These maps are used to generate
<code class="docutils literal notranslate"><span class="pre">Simulation_mapParticlesVar</span></code>, which takes the particle property
<em>partname</em> and returns <em>varname</em> and <em>vartype</em>. For example, to
have a particle property tracing density:</div>
</div>
<div class="codeseg docutils container">
<p>PARTICLEPROP dens REAL PARTICLEMAP TO dens FROM VARIABLE dens</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SPECIES</span></code> <em>name</em> [TO <em>number of ions</em>]</div>
<div class="line">An application that uses multiple species uses this keyword to
define them. See for more information. The user may also specify an
optional number of ions for each element, <em>name</em>. For example,
<code class="docutils literal notranslate"><span class="pre">SPECIES</span></code> <em>o</em> TO <em>8</em> creates 9 spaces in <code class="docutils literal notranslate"><span class="pre">unk</span></code> for Oxygen, that
is, a single space for Oxygen and 8 spaces for each of its ions.
This is relevant to simulations using the <code class="docutils literal notranslate"><span class="pre">ionize</span></code> unit.
(Omitting the optional <code class="docutils literal notranslate"><span class="pre">TO</span></code> specifier is equivalent to specifying
<code class="docutils literal notranslate"><span class="pre">TO</span></code> 0).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DATAFILES</span></code> <em>wildcard</em></div>
<div class="line">Declares that all files matching the given wildcard in the unit
directory should be copied over to the object directory. For
example,</div>
</div>
<div class="codeseg docutils container">
<p>DATAFILES *.dat</p>
</div>
<p>will copy all the “.dat” files to the object directory.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">KERNEL</span></code> <em>[subdir]</em></div>
<div class="line">Declares that all subdirectories must be recursively included. This
usually marks the end of the high level architecture of a unit.
Directories below it may be third party software or a highly
optimized solver, and are therefore not required to conform to
Flash-X architecture.</div>
</div>
<p>Without a <em>subdir</em>, the current directory (<em>i.e.</em>, the one containing
the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file with the <code class="docutils literal notranslate"><span class="pre">KERNEL</span></code> keyword) is marked as a
kernel directory, so code from all its subdirectories (with the
exception of subdirectories whose name begins with a dot) is
included. When a <em>subdir</em> is given, then that subdirectory must
exist, and it is treated as a kernel directory in the same way.</p>
<p>Note that currently the <code class="docutils literal notranslate"><span class="pre">setup</span></code> script can process only one
<code class="docutils literal notranslate"><span class="pre">KERNEL</span></code> directive per <code class="docutils literal notranslate"><span class="pre">Config</span></code> file.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">LIBRARY</span></code> <em>name</em></div>
<div class="line">Specifies a library requirement. Different Flash-X units require
different libraries, and they must inform <code class="docutils literal notranslate"><span class="pre">setup</span></code> so it can link
the libraries into the executable. Some valid library names are
<code class="docutils literal notranslate"><span class="pre">HDF5,</span> <span class="pre">MPI</span></code>. Support for external libraries can be added by
modifying the site-specific <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> files to include
appropriate Makefile macros. It is possible to use internal
libraries, as well as switch libraries at setup time. To use these
features, see</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">LINKIF</span></code> <em>filename componentname</em></div>
<div class="line">Specifies that the file <em>filename</em> should be used only when the
compenent <code class="docutils literal notranslate"><span class="pre">componentname</span></code> is included. This keyword allows a unit to have
multiple implementations of any part of its functionality, even
down to the kernel level, without the necessity of creating
children for every alternative. This is especially useful in
Simulation setups where users may want to use different
implementations of specific functions based upon the units
included. For instance, a user may wish to supply his/her own
implementation of <code class="docutils literal notranslate"><span class="pre">Grid_markRefineDerefine.F90</span></code>, instead of using
the default one provided by Flash-X. However, this function is
aware of the internal workings of <code class="docutils literal notranslate"><span class="pre">Grid</span></code>, and has different
implementations for different grid packages. The user could
therefore specify different versions of his/her own file that are
intended for use with the different grids. For example, adding</div>
</div>
<div class="codeseg docutils container">
<p>LINKIF Grid_markRefineDerefine.F90.ug Grid/GridMain/UG LINKIF
Grid_markRefineDerefine.F90.pmesh Grid/GridMain/paramesh</p>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file ensures that if the application is built with
<code class="docutils literal notranslate"><span class="pre">UG</span></code>, the file <code class="docutils literal notranslate"><span class="pre">Grid_markRefineDerefine.F90.ug</span></code> will be linked in
as <code class="docutils literal notranslate"><span class="pre">Grid_markRefineDerefine.F90</span></code>, whereas if it is built with
<code class="docutils literal notranslate"><span class="pre">|paramesh|2</span></code> or <code class="docutils literal notranslate"><span class="pre">|paramesh|4.0</span></code> or <code class="docutils literal notranslate"><span class="pre">|paramesh|4dev</span></code>, then the file
<code class="docutils literal notranslate"><span class="pre">Grid_markRefineDerefine.F90.pmesh</span></code> will be linked in as
<code class="docutils literal notranslate"><span class="pre">Grid_markRefineDerefine.F90</span></code>. Alternatively, the user may want to
provide only one implementation specific to, say, <code class="docutils literal notranslate"><span class="pre">PARAMESH</span></code>. In
this case, adding</p>
<div class="codeseg docutils container">
<p>LINKIF Grid_markRefineDerefine.F90 Grid/GridMain/paramesh</p>
</div>
<p>to the Config file ensures that the user-supplied file is included
when using <code class="docutils literal notranslate"><span class="pre">PARAMESH</span></code>(either version), while the default Flash-X
file is included when using <code class="docutils literal notranslate"><span class="pre">UG</span></code>.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PPDEFINE</span></code> <em>sym1 sym2 …</em></div>
<div class="line">Instructs setup to add the PreProcessor symbols <code class="docutils literal notranslate"><span class="pre">SYM1</span></code> and
<code class="docutils literal notranslate"><span class="pre">SYM2</span></code> to the generated <code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code>. Here <code class="docutils literal notranslate"><span class="pre">SYM1</span></code> is <em>sym1</em>
converted to uppercase. These pre-process symbols can be used in
the code to distinguish between which units have been used in an
application. For example, a Fortran subroutine could include</div>
</div>
<div class="codeseg docutils container">
<p>#ifdef <a href="#id3"><span class="problematic" id="id4">|</span></a>flashx|_GRID_UG ug specific code #endif</p>
<p>#ifdef <a href="#id5"><span class="problematic" id="id6">|</span></a>flashx|_GRID_PARAMESH3OR4 pm3+ specific code #endif</p>
</div>
<p>By convention, many preprocessor symbols defined in Config files
included in the Flash-X code distribution start with the prefix
“Flash-X_”.</p>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">USESETUPVARS</span> <span class="pre">var1,</span> <span class="pre">var2,</span> <span class="pre">…</span></code></div>
<div class="line">This tells <code class="docutils literal notranslate"><span class="pre">setup</span></code> that the specified “Setup Variables” are being
used in this <code class="docutils literal notranslate"><span class="pre">Config</span></code> file. The variables initialize to an empty
string if no values are specified for them. Note that commas are
required if listing several variables.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">CHILDORDER</span></code> <em>child1 child2 …</em></div>
<div class="line">When <code class="docutils literal notranslate"><span class="pre">setup</span></code> links several implementations of the same function,
it ensures that implementations of children override that of the
parent. Its method is to lexicographically sort all the names and
allow implementations occurring later to override those occurring
earlier. This means that if two siblings implement the same code,
the names of the siblings determine which implementation wins.
Although it is very rare for two siblings to implement the same
function, it does occur. This keyword permits the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file
to override the lexicographic order by one preferred by the user.
Lexicographic ordering will prevail as usual when deciding among
implementations that are not explicitly listed.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">GUARDCELLS</span></code> <em>num</em></div>
<div class="line">Allows an application to choose the stencil size for updating grid
points. The stencil determines the number of guardcells needed. The
PPM algorithm requires <span class="math notranslate nohighlight">\(4\)</span> guardcells, hence that is the
default value. If an application specifies a smaller value, it will
probably not be able to use the default <code class="docutils literal notranslate"><span class="pre">monotonic</span></code> AMR Grid
interpolation; see the <code class="docutils literal notranslate"><span class="pre">-gridinterpolation</span></code> <code class="docutils literal notranslate"><span class="pre">setup</span></code> flag for
additional information.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SETUPERROR</span> <span class="pre">error</span> <span class="pre">message</span></code></div>
<div class="line">This causes <code class="docutils literal notranslate"><span class="pre">setup</span></code> to abort with the specified error message.
This is usually used only inside a conditional IF/ENDIF block (see
below).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">IF,</span> <span class="pre">ELSEIF,</span> <span class="pre">ELSE,</span> <span class="pre">ENDIF</span></code></div>
<div class="line">A conditional block is of the following form:</div>
</div>
<div class="codeseg docutils container">
<p>IF cond … ELSEIF cond … ELSE … ENDIF</p>
</div>
<p>where the <code class="docutils literal notranslate"><span class="pre">ELSEIF</span></code> and <code class="docutils literal notranslate"><span class="pre">ELSE</span></code> blocks are optional. There is no
limit on the number of <code class="docutils literal notranslate"><span class="pre">ELSEIF</span></code> blocks. “…” is any sequence of
valid <code class="docutils literal notranslate"><span class="pre">Config</span></code> file syntax. The conditional blocks may be nested.
“cond” is any boolean valued Python expression using the setup
variables specified in the <code class="docutils literal notranslate"><span class="pre">USESETUPVARS</span></code>.</p>
</li>
</ul>
</section>
<section id="the-setup-tool">
<span id="sec-the-setup-tool"></span><h2>The Setup Tool<a class="headerlink" href="#the-setup-tool" title="Permalink to this heading"></a></h2>
<p>The setup tool parses and interprets the Config files to assemble an
application instance in the specified object directory. It has three
primary actions to perform.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Compile a list of source files to be included in the
application. This compilation process ends with all the needed
files assembled in the object directory. Some may be linked
directly from their location in the source tree, while others may
have been generated through some additional actions taken by the
setup tool described in Figure …</p></li>
<li><p>Compile and initialize a list of runtime parameters needed by the simulation</p></li>
<li><p>Generate Makefile.Unit for each unit that will be included in the
main Makefile used for compiling the source code. Note that the
Flash-X build system assumes GNU Make.</p></li>
</ol>
</div></blockquote>
<p>The setup tool traverses the Flash-X source tree starting from the
directory hosting the specific application definition. This starting
directory is essentially the selected implementation of the
“Simulation” unit.  It accumulates  units, subunits and other
compoments from where source code is to be collected through recursive
traversal of all encountered dependencies. While traversing the source
tree the setup tool uses the following inheritance rules to arbitrate
on versions of the source code functions, versions of key definitions
and initial values of runtime parameters.</p>
<ul>
<li><p>All files with valid source extensions (such as .F90, .c, .h) are
added to the list and are linked into the object directory</p>
<ul class="simple">
<li><p>If a file with identical name in already included in the list the
existing link in the object directory is removed and replaced with
a link to the newly encountered file</p></li>
<li><p>The source files in the Simulation unit are the last ones to be
added to  the list, and therefore can override any file from the
source tree in the object directory</p></li>
</ul>
</li>
<li><p>If a file has a .ini extension it indicates to the setup tool that
it contains definitions for the keys. All the keys defined in the
file are added to the list of available keys.</p>
<ul class="simple">
<li><p>If a key already existed in the list, its defintion is replaced by
the most recently encountered definition.</p></li>
<li><p>Similar to source files, a definition in the Simulation unit
overrides any existing definition of a key.</p></li>
</ul>
</li>
<li><p>An -mc appended to the name of a file indicates to the setup tool
that the file is augmented with keys and needs to be translated</p>
<ul class="simple">
<li><p>An augmented file foo.F90-mc may have a <em>Novariant</em> directive, in
which case the keys are replaced by the corresponding
definitions and the emitted code is placed in a file foo.F90 in
the object directory. Note that foo.F90 never comes into
existence anywhere in the source tree, so foo.F90 in the object
directory is a physical file, not a link.</p></li>
<li><p>If the aumented file does not have <em>Novariant</em> directive then the
setup tool generates its variants.</p>
<ul>
<li><p>It looks for paths specified for the variants in the list of
REQUIRES.</p></li>
<li><p>For every variant it temporarily addes the keys defined in the
path to list of available keys, which are removed from the list
as soon as the translated code is emitted.</p></li>
<li><p>The emitted code is placed in the object directory with the name
foo_thisvariant.F90.</p></li>
<li><p>It is assumed that the function or subroutine names are defined
to be variant dependent in these files. For details on how to do
this correctly see …..</p></li>
<li><p>In Makefile.Unit instances of foo.o are replaced with
foo_variants.o for all available variants.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>If any file has the <em>Reorder</em> directive it undergoes a code
transformation where the order of indices in the arrays is changed
as specified. The emitted code is placed in a file with the same
name as the original file and the link to the source tree is removed.</p></li>
<li><p>Runtime parameters defined in the Config file are added to the list
of runtime parameters and initialized with the specified value.</p>
<ul class="simple">
<li><p>If a runtime parameter already exists in the list its value is
replaced with the most recently encountered value</p></li>
<li><p>The Simulation unit is the last one to be processed, therefore
initial values specified in its Config file override other values.</p></li>
</ul>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">setup</span></code> script determines site-dependent configuration information</p>
</div></blockquote>
</li>
</ul>
<p>by looking for a directory <code class="docutils literal notranslate"><span class="pre">sites/&lt;hostname&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;hostname&gt;</span></code> is
the hostname of the machine on which Flash-X is running. <a class="footnote-reference brackets" href="#id23" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> Failing
this, it looks in <code class="docutils literal notranslate"><span class="pre">sites/Prototypes/</span></code> for a directory with the same
name as the output of the <code class="docutils literal notranslate"><span class="pre">uname</span></code> command. The site and operating
system type can be overridden with the <code class="docutils literal notranslate"><span class="pre">-site</span></code> and <code class="docutils literal notranslate"><span class="pre">-ostype</span></code>
command-line options to the <code class="docutils literal notranslate"><span class="pre">setup</span></code> command. Only one of these options
can be used at one time. The directory for each site and operating
system type contains a makefile fragment <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> that sets
command names, compiler flags, library paths, and any replacement or
additional source files needed to compile Flash-X for that specific
machine and machine type.</p>
<section id="setup-arguments">
<span id="sec-listsetupargs"></span><h3>Setup Arguments<a class="headerlink" href="#setup-arguments" title="Permalink to this heading"></a></h3>
<p>The setup script accepts a large number of command line arguments which
affect the simulation in various ways. These arguments are divided into
three categories:</p>
<ol class="arabic simple">
<li><p><em>Setup Options</em> (example: <code class="docutils literal notranslate"><span class="pre">-auto</span></code>) begin with a dash and are built
into the setup script itself. Many of the most commonly used
arguments are setup options.</p></li>
<li><p><em>Setup Variables</em> (example: <code class="docutils literal notranslate"><span class="pre">species=air,h2o</span></code>) are defined by
individual units. When writing a <code class="docutils literal notranslate"><span class="pre">Config</span></code> file for any unit, you
can define a setup variable. explains how setup variables can be
created and used.</p></li>
<li><p><em>Setup Shortcuts</em> (example: <code class="docutils literal notranslate"><span class="pre">+ug</span></code>) begin with a plus symbol and are
essentially macros which automatically include a set of setup
variables and/or setup options. New setup shortcuts can be easily
defined, see for more information.</p></li>
</ol>
<blockquote>
<div><blockquote>
<div><p><em>-verbose=</em>  instructs the level of verbosity in progress messages
printed by the setup tool. Different levels (in order of increasing verbosity) are
ERROR, IMPINFO, WARN, INFO, DEBUG}. The default is WARN.</p>
</div></blockquote>
<p><em>-auto</em> indicates to the setup tool that it should select <em>DEFAULT</em>
in every traversed path unless an alternative is explicitly specified
either at commandline or in one of the already traversed Config
files. In the process a text file containing a list of all traversed
paths is created and is placed in the object directory.</p>
<p><a href="#id8"><span class="problematic" id="id9">*</span></a>-[123]d specifies the dimensionality of the simulation. The default
is 2d.</p>
<p><em>-maxblocks=</em> is relevant only when using PARAMESH. It lets the AMR
know how many blocks to allocate for the state variables. Note that
if the number of blocks generated on a process exceeds maxblocks the
execution will abort.</p>
</div></blockquote>
<p><a href="#id10"><span class="problematic" id="id11">*</span></a>-nxb=/ -nyb=  / -nzb= * specify the number of data points (also
called cells)  along each dimension of the every block in the setup</p>
<p><em>-debug /-opt /-test</em> are options used to select the level of
optimization to used by the compilers. The defauls is -opt. The
Makefile.h in the site directory defines the flags associated with
each of these options, and the users can customize them as they want.</p>
<p><em>-objdir=&lt;dir&gt;</em> allows the user to specify the path where they wish
the executable to be built. The default is <em>object</em> at the same level
as the source directory.</p>
<p><em>-with-unit=&lt;path&gt;</em> is used to specify to the setup tool that the
source code at the specified path is to be included. The specification
of the path on commandline can override any dependency in the
traversal that had a <em>REQUESTS</em> associated with it. And it can add
dependencies that were not included with -auto option.</p>
<p><em>-without-unit=&lt;path&gt;</em> is used to tell the setup tool not to include
the code in the specified path. This option can also override
<em>REQUIRES</em> encountered during the traversal.</p>
<p><em>-geometry=&lt;geometry&gt;</em> is used to specify one of the supported
geometries &lt;cartesian, cylindrical, spherical, polar&gt;, the default is
cartesian.</p>
<p><em>-defines=&lt;def&gt;</em>/  causes the specified pre-processor symbols to be defined when
the code is being compiled. This is useful for code segments
surrounded by preprocessor directives that are to be included only if
a particular implementation of a unit is selected.</p>
<p><em>-nofbs</em> non-fixed-block size mode where nxb, nyb and nzb are not
fixed at compile time.</p>
<p><em>-gridinterpolation=&lt;scheme&gt;</em>  is used to select a scheme for Grid interpolation.</p>
<p><em>-makefile=&lt;extension&gt;}</em> is used when a site can work with more than
one compiler suite. In such situations the site can have several
Makefile.h’s named as Makefile.h.&lt;extension&gt; and the one specified
with this option will be selected</p>
<p><em>-index-reorder</em>  instructs setup order the indices in state variables
as specified. This feature is needed because the base data structure
in PARAMESH expects the variable index to be first while AMReX needs
it to be last. This feature permits the same code base to work in both
modes.</p>
<p><em>-parfile=&lt;filename&gt;</em>  causes setup to copy the specified runtime-parameters file in
the simulation directory to the object directory and name it
flash.par. By default every setup distributed has a flash.par which is
copied into the object directory if this option is not used.</p>
<p><a href="#id12"><span class="problematic" id="id13">*</span></a>-append-parfiles=[location1]&lt;filename1&gt;,[location2]&lt;filename2&gt; …
takes a comma-separated list of names of parameter
files and combines them into one flash.par file in the object directory.
File names without an absolute path are taken to be relative to the simulation
directory, in a way similat to that  for the -parfile option.</p>
<p><em>-portable</em> this option causes setup copy instead of linking source files.</p>
<p><em>-site=&lt;site&gt;</em> specifies the suddirectory of the “sites” directory
from where to fetch Makefile.h</p>
<p><em>-with-library=&lt;libname&gt;[,args]</em>  instructs setup to link in the
specified library when building the final executable. The libraty in
questoin can be internal or external. If external the user must make
sure that the appropriate path to the library is provided in their
site’s Makefile.h. An internal library will be built by the setup if
it hasn’t already been done so by an earlier invocation.</p>
<p><em>-without-library=&lt;libname&gt;</em> is used to override the need for a
library specified by one the Config files traversed by the setup
tool.</p>
</section>
<section id="using-shortcuts">
<span id="sec-setupshortcuts"></span><h3>Using Shortcuts<a class="headerlink" href="#using-shortcuts" title="Permalink to this heading"></a></h3>
<p>Apart from the various setup options the <code class="docutils literal notranslate"><span class="pre">setup</span></code> script also allows
you to use shortcuts for frequently used combinations of options. For
example, instead of typing in</p>
<div class="codeseg docutils container">
<p>./setup -a Sod -with-unit=Grid/GridMain/UG</p>
</div>
<p>you can just type</p>
<div class="codeseg docutils container">
<p>./setup -a Sod +ug</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">+ug</span></code> or any setup option starting with a ‘+’ is considered as a
shortcut. By default, setup looks at <code class="docutils literal notranslate"><span class="pre">bin/setup_shortcuts.txt</span></code> for a
list of declared shortcuts. You can also specify a “:” delimited list of
files in the environment variable <code class="docutils literal notranslate"><span class="pre">SETUP_SHORTCUTS</span></code> and <code class="docutils literal notranslate"><span class="pre">setup</span></code> will
read all the files specified (and ignore those which don’t exist) for
shortcut declarations. See for an example file.</p>
<div class="fcodeseg docutils container">
<p># comment line</p>
<p># each line is of the form # shortcut:arg1:arg2:…: # These
shortcuts can refer to each other.</p>
<p>default:–with-library=mpi:-unit=IO/IOMain:-gridinterpolation=monotonic</p>
<p># io choices noio:–without-unit=IO/IOMain: io:–with-unit=IO/IOMain:</p>
<p># Choice of Grid ug:-unit=Grid/GridMain/UG:
pm2:-unit=Grid/GridMain/paramesh/<a href="#id14"><span class="problematic" id="id15">|</span></a>paramesh|2:
pm40:-unit=Grid/GridMain/paramesh/paramesh4/<a href="#id16"><span class="problematic" id="id17">|</span></a>paramesh|4.0:
pm4dev:-unit=Grid/GridMain/paramesh/paramesh4/<a href="#id18"><span class="problematic" id="id19">|</span></a>paramesh|4dev:</p>
<p># frequently used geometries cube64:-nxb=64:-nyb=64:-nzb=64:</p>
</div>
<p>The shortcuts are replaced by their expansions in place, so options
which come after the shortcut override (or conflict with) options
implied by the shortcut. A shortcut can also refer to other shortcuts as
long as there are no cyclic references.</p>
<p>The “default” shortcut is special. <code class="docutils literal notranslate"><span class="pre">setup</span></code> always prepends
<code class="docutils literal notranslate"><span class="pre">+default</span></code> to its command line thus making <code class="docutils literal notranslate"><span class="pre">./setup</span> <span class="pre">-a</span> <span class="pre">Sod</span></code>
equivalent to <code class="docutils literal notranslate"><span class="pre">./setup</span> <span class="pre">+default</span> <span class="pre">-a</span> <span class="pre">Sod</span></code>. Thus changing the default IO
to “hdf5/parallel”, is as simple as changing the definition of the
“default” shortcut.</p>
<p>Some of the more commonly used shortcuts are described below:</p>
<div class="center docutils container">
<div class="docutils container" id="tab-setup-shortcuts">
<table class="docutils align-default" id="id25">
<caption><span class="caption-text">Shortcuts for often-used options</span><a class="headerlink" href="#id25" title="Permalink to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Shortcut</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>+cartesian</p></td>
<td><p>use cartesian geometry</p></td>
</tr>
<tr class="row-odd"><td><p>+cylindrical</p></td>
<td><p>use cylindrical geometry</p></td>
</tr>
<tr class="row-even"><td><p>+noio</p></td>
<td><p>omit IO</p></td>
</tr>
<tr class="row-odd"><td><p>+nolog</p></td>
<td><p>omit logging</p></td>
</tr>
<tr class="row-even"><td><p>+pm4dev</p></td>
<td><p>use the PARAMESH4DEV grid</p></td>
</tr>
<tr class="row-odd"><td><p>+polar</p></td>
<td><p>use polar geometry</p></td>
</tr>
<tr class="row-even"><td><p>+spherical</p></td>
<td><p>use spherical geometry</p></td>
</tr>
<tr class="row-odd"><td><p>+ug</p></td>
<td><p>use the uniform grid in a fixed block size mode</p></td>
</tr>
<tr class="row-even"><td><p>+nofbs</p></td>
<td><p>use the uniform grid in a non-fixed block size mode</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="setup-variables-and-preprocessing-config-files">
<span id="sec-setupvariables"></span><h3>Setup Variables and Preprocessing <code class="docutils literal notranslate"><span class="pre">Config</span></code> Files<a class="headerlink" href="#setup-variables-and-preprocessing-config-files" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">setup</span></code> allows you to assign values to “Setup Variables”. These
variables can be string-valued, integer-valued, or boolean. A <code class="docutils literal notranslate"><span class="pre">setup</span></code>
call like</p>
<div class="codeseg docutils container">
<p>./setup -a Sod Foo=Bar Baz=True</p>
</div>
<p>sets the variable “Foo” to string “Bar” and “Baz” to boolean True <a class="footnote-reference brackets" href="#id24" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.
<code class="docutils literal notranslate"><span class="pre">setup</span></code> can conditionally include and exclude parts of the <code class="docutils literal notranslate"><span class="pre">Config</span></code>
file it reads based on the values of these variables. For example, the
<code class="docutils literal notranslate"><span class="pre">IO/IOMain/hdf5/Config</span></code> file contains</p>
<div class="shrink docutils container">
<div class="fcodeseg docutils container">
<p>DEFAULT serial</p>
<p>USESETUPVARS parallelIO</p>
<p>IF parallelIO DEFAULT parallel ENDIF</p>
</div>
</div>
<p>The code sets IO to its default value of “serial” and then resets it to
“parallel” if the setup variable “parallelIO” is True. The
<code class="docutils literal notranslate"><span class="pre">USESETUPVARS</span></code> keyword in the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file instructs setup that the
specified variables must be defined; undefined variables will be set to
the empty string.</p>
<p>Through judicious use of setup variables, the user can ensure that
specific implementations are included or the simulation is properly
configured. For example, the setup line <code class="docutils literal notranslate"><span class="pre">./setup</span> <span class="pre">-a</span> <span class="pre">Sod</span> <span class="pre">+ug</span></code> expands
to <code class="docutils literal notranslate"><span class="pre">./setup</span> <span class="pre">-a</span> <span class="pre">Sod</span> <span class="pre">-unit=Grid/GridMain/</span> <span class="pre">Grid=UG</span></code>. The relevant part of
the <code class="docutils literal notranslate"><span class="pre">Grid/GridMain/Config</span></code> file is given below:</p>
<div class="shrink docutils container">
<div class="fcodeseg docutils container">
<p># Requires use of the Grid SetupVariable USESETUPVARS Grid</p>
<p>DEFAULT paramesh</p>
<p>IF Grid==’UG’ DEFAULT UG ENDIF IF Grid==’PM2’ DEFAULT
paramesh/<a href="#id21"><span class="problematic" id="id22">|</span></a>paramesh|2 ENDIF</p>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Grid/GridMain/Config</span></code> file defaults to choosing <code class="docutils literal notranslate"><span class="pre">PARAMESH</span></code>. But
when the setup variable Grid is set to “UG” through the shortcut
<code class="docutils literal notranslate"><span class="pre">+ug</span></code>, the default implementation is set to “UG”. The same technique
is used to ensure that the right IO unit is automatically included.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">bin/Readme.SetupVars</span></code> for an exhaustive list of Setup Variables
which are used in the various Config files. For example the setup
variable <code class="docutils literal notranslate"><span class="pre">nDim</span></code> can be test to ensure that a simulation is configured
with the appropriate dimensionality (see for example
<code class="docutils literal notranslate"><span class="pre">Simulation/SimulationMain/unitTest/Eos/Config</span></code>).</p>
</section>
<section id="creating-a-site-specific-makefile">
<span id="sec-setupmakefile"></span><h3>Creating a Site-specific <code class="docutils literal notranslate"><span class="pre">Makefile</span></code><a class="headerlink" href="#creating-a-site-specific-makefile" title="Permalink to this heading"></a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">setup</span></code> does not find your hostname in the <code class="docutils literal notranslate"><span class="pre">sites/</span></code> directory it
picks a default <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> based on the operating system. This
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code> is not always correct but can be used as a template to
create a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> for your machine. To create a Makefile specific to
your system follow these instructions.</p>
<ul class="simple">
<li><p>Create the directory <code class="docutils literal notranslate"><span class="pre">sites/&lt;hostname&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;hostname&gt;</span></code> is
the hostname of your machine.</p></li>
<li><p>Start by copying <code class="docutils literal notranslate"><span class="pre">os/&lt;your</span> <span class="pre">os&gt;/Makefile.h</span></code> to <code class="docutils literal notranslate"><span class="pre">sites/&lt;hostname&gt;</span></code></p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">bin/suggestMakefile.sh</span></code> to help identify the locations of
various libraries on your system. The script scans your system and
displays the locations of some libraries. You must note the location
of <code class="docutils literal notranslate"><span class="pre">MPI</span></code> library as well. If your compiler is actually an
mpi-wrapper (<em>e.g.</em><code class="docutils literal notranslate"><span class="pre">mpif90</span></code>), you must still define <code class="docutils literal notranslate"><span class="pre">LIB_MPI</span></code>
in your site specific <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> as the empty string.</p></li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">sites/&lt;hostname&gt;/Makefile.h</span></code> to provide the locations of
various libraries on your system.</p></li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">sites/&lt;hostname&gt;/Makefile.h</span></code> to specify the FORTRAN and C
compilers to be used.</p></li>
</ul>
<div class="flashtip docutils container">
<p>The Makefile.h <em>must</em> include a compiler flag to promote Fortran
<code class="docutils literal notranslate"><span class="pre">Reals</span></code> to <code class="docutils literal notranslate"><span class="pre">Double</span> <span class="pre">Precision</span></code>. Flash-X performs all <code class="docutils literal notranslate"><span class="pre">MPI</span></code>
communication of Fortran <code class="docutils literal notranslate"><span class="pre">Reals</span></code> using <code class="docutils literal notranslate"><span class="pre">MPI_DOUBLE_PRECISION</span></code>
type, and assumes that Fortran <code class="docutils literal notranslate"><span class="pre">Reals</span></code> are interoperable with C
<code class="docutils literal notranslate"><span class="pre">doubles</span></code> in the I/O unit.</p>
</div>
</section>
<section id="files-created-during-the-setup-process">
<h3>Files Created During the <code class="docutils literal notranslate"><span class="pre">setup</span></code> Process<a class="headerlink" href="#files-created-during-the-setup-process" title="Permalink to this heading"></a></h3>
<p>The setup tool generates many files in the directory. They fall into
three major categories:</p>
<ul class="simple">
<li><p>Files not required to build the Flash-X executable, but which contain
useful information,</p></li>
<li><p>Generated or C code, and</p></li>
<li><p>Makefiles required to compile the Flash-X executable.</p></li>
</ul>
</section>
</section>
<section id="informational-files">
<h2>Informational files<a class="headerlink" href="#informational-files" title="Permalink to this heading"></a></h2>
<p>These files are generated before compilation by <code class="docutils literal notranslate"><span class="pre">setup</span></code>. Each of these
files begins with the prefix <code class="docutils literal notranslate"><span class="pre">setup_</span></code> for easy identification.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_call</span></code></p></td>
<td><p>contains the options with which <code class="docutils literal notranslate"><span class="pre">setup</span></code> was
called and the command line resulting after
shortcut expansion</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">setup_libraries</span></code></p></td>
<td><p>contains the list of libraries and their
arguments used to generate the executable</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_units</span></code></p></td>
<td><p>contains the list of all units which were
included in the current setup</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">setup_defines</span></code></p></td>
<td><p>contains a list of all pre-process symbols
passed to the compiler invocation directly</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_flags</span></code></p></td>
<td><p>contains the exact compiler and linker flags</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">setup_params</span></code></p></td>
<td><p>contains the list of runtime parameters
defined in the <code class="docutils literal notranslate"><span class="pre">Config</span></code> files processed by
<code class="docutils literal notranslate"><span class="pre">setup</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_vars</span></code></p></td>
<td><p>contains the list of variables, fluxes
with their descriptions.</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="code-generated-by-the-setup-call">
<h2>Code generated by the <code class="docutils literal notranslate"><span class="pre">setup</span></code> call<a class="headerlink" href="#code-generated-by-the-setup-call" title="Permalink to this heading"></a></h2>
<p>These routines are generated by the setup call and provide
simulation-specific code.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_buildstamp.F90</span></code></p></td>
<td><p>contains code for the subroutine
<code class="docutils literal notranslate"><span class="pre">setup_buildstamp</span></code> which
returns the setup and build time
as well as code for
<code class="docutils literal notranslate"><span class="pre">setup_systemInfo</span></code> which
returns the <em>uname</em> of the
system used to setup the problem</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">setup_call.F90</span></code></p></td>
<td><p>contains code which returns
build statistics including the
actual <code class="docutils literal notranslate"><span class="pre">setup</span></code> call as well as
the compiler flags used for the
build</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">setup_getFlashUnits.F90</span></code></p></td>
<td><p>contains code to retrieve the
number and list of flashUnits
used to compile code</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>contains code to retrieve the
version of Flash-X used for the
build</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code></p></td>
<td><p>contains simulation specific
preprocessor macros, which
change based upon setup unlike
<code class="docutils literal notranslate"><span class="pre">constants.h</span></code>. It is described
in</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>contains code to map an index
described in <code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code> to
a string described in the
<code class="docutils literal notranslate"><span class="pre">Config</span></code> file.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Simulation/Si</span>
<span class="pre">mulation_mapStrToInt</span></code><code class="docutils literal notranslate"><span class="pre">.F90</span></code></p></td>
<td><p>contains code to map a string
described in the <code class="docutils literal notranslate"><span class="pre">Config</span></code> file
to an integer index described in
the <code class="docutils literal notranslate"><span class="pre">Simulation.h</span></code> file.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>contains a mapping between
particle properties and grid
variables. Only generated when
particles are included in a
simulation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Particles/Part</span>
<span class="pre">icles_specifyMethods</span></code><code class="docutils literal notranslate"><span class="pre">.F90</span></code></p></td>
<td><p>contains code to make a data
structure with information about
the mapping and initialization
method for each type of
particle. Only generated when
particles are included in a
simulation.</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="makefiles-generated-by-setup">
<span id="sec-unitmakefiles"></span><h2>Makefiles generated by <code class="docutils literal notranslate"><span class="pre">setup</span></code><a class="headerlink" href="#makefiles-generated-by-setup" title="Permalink to this heading"></a></h2>
<p>Apart from the master <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, <code class="docutils literal notranslate"><span class="pre">setup</span></code> generates a makefile for
each unit, which is “included” in the master <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. This is true
even if the unit is not included in the application. These unit
makefiles are named <code class="docutils literal notranslate"><span class="pre">Makefile.Unit</span></code> and are a concatenation of all the
Makefiles found in unit hierarchy processed by <code class="docutils literal notranslate"><span class="pre">setup</span></code>.</p>
<p>For example, if an application uses
<code class="docutils literal notranslate"><span class="pre">Grid/GridMain/paramesh/paramesh4/|paramesh|4.0</span></code>, the file
<code class="docutils literal notranslate"><span class="pre">Makefile.Grid</span></code> will be a concatenation of the Makefiles found in</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Grid</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Grid/GridMain</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Grid/GridMain/paramesh</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Grid/GridMain/paramesh/paramesh4</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Grid/GridMain/paramesh/paramesh4/|paramesh|4.0</span></code></p></li>
</ul>
<p>As another example, if an application does not use
<code class="docutils literal notranslate"><span class="pre">PhysicalConstants</span></code>, then <code class="docutils literal notranslate"><span class="pre">Makefile.PhysicalConstants</span></code> is just the
contents of <code class="docutils literal notranslate"><span class="pre">PhysicalConstants/Makefile</span></code> at the API level.</p>
<p>Since the order of concatenation is arbitrary, the behavior of the
Makefiles should not depend on the order in which they have been
concatenated. The makefiles inside the units contain lines of the form:</p>
<div class="codeseg docutils container">
<p>Unit += file1.o file2.o …</p>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">Unit</span></code> is the name of the unit, which was <code class="docutils literal notranslate"><span class="pre">Grid</span></code> in the
example above. Dependency on data modules files <em>need not be specified</em>
since the setup process determines this requirement automatically.</p>
<section id="setup-a-hybrid-mpi-openmp-flashx-application">
<span id="sec-hybridsetup"></span><h3>Setup a hybrid MPI+|openmp| Flash-X application<a class="headerlink" href="#setup-a-hybrid-mpi-openmp-flashx-application" title="Permalink to this heading"></a></h3>
<p>The Flash-X multithreading requires a MPI-2 installation built with
thread support (building with an MPI-1 installation or an MPI-2
installation without thread support is possible but strongly
discouraged). The Flash-X application requests the thread support level
<code class="docutils literal notranslate"><span class="pre">MPI_THREAD_SERIALIZED</span></code> to ensure that the MPI library is thread-safe
and that any OpenMP thread can call MPI functions safely. You should
also make sure that your compiler provides a version of OpenMP which is
compliant with at least the OpenMP 2.5 (200505) standard (older versions
may also work but I have not checked).</p>
<p>In order to make use of the multithreaded code you must setup your
application with one of the setup variables <code class="docutils literal notranslate"><span class="pre">threadBlockList</span></code>,
<code class="docutils literal notranslate"><span class="pre">threadWithinBlock</span></code> or <code class="docutils literal notranslate"><span class="pre">threadRayTrace</span></code> equal to <code class="docutils literal notranslate"><span class="pre">True</span></code>, e.g.</p>
<div class="codeseg docutils container">
<p>./setup Sedov -auto threadBlockList=True ./setup Sedov -auto
threadBlockList=True +mpi1 (compatible with MPI-1 - unsafe!)</p>
</div>
<p>When you do this the setup script will insert <code class="docutils literal notranslate"><span class="pre">USEOPENMP</span> <span class="pre">=</span> <span class="pre">1</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">USEOPENMP</span> <span class="pre">=</span> <span class="pre">0</span></code> in the generated Makefile. If it is equal to
<span class="math notranslate nohighlight">\(1\)</span> the Makefile will prepend an OpenMP variable to the
<code class="docutils literal notranslate"><span class="pre">FFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">LFLAGS</span></code> variables.</p>
<div class="flashtip docutils container">
<p>In general you should not define <code class="docutils literal notranslate"><span class="pre">FLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> and <code class="docutils literal notranslate"><span class="pre">LFLAGS</span></code>
in your <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code>. It is much better to define <code class="docutils literal notranslate"><span class="pre">FFLAGS_OPT</span></code>,
<code class="docutils literal notranslate"><span class="pre">FFLAGS_TEST</span></code>, <code class="docutils literal notranslate"><span class="pre">FFLAGS_DEBUG</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS_OPT</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS_TEST</span></code>,
<code class="docutils literal notranslate"><span class="pre">CFLAGS_DEBUG</span></code>, <code class="docutils literal notranslate"><span class="pre">LFLAGS_OPT</span></code>, <code class="docutils literal notranslate"><span class="pre">LFLAGS_TEST</span></code> and
<code class="docutils literal notranslate"><span class="pre">LFLAGS_DEBUG</span></code> in your <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code>. The setup script will then
initialize the <code class="docutils literal notranslate"><span class="pre">FFLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> and <code class="docutils literal notranslate"><span class="pre">LFLAGS</span></code> variables in the
Makefile appropriately for an optimized, test or debug build.</p>
</div>
<p>The OpenMP variables should be defined in your <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> and
contain a compiler flag to recognize OpenMP directives. In most cases it
is sufficient to define a single variable named <code class="docutils literal notranslate"><span class="pre">OPENMP</span></code>, but you may
encounter special situations when you need to define <code class="docutils literal notranslate"><span class="pre">OPENMP_FORTRAN</span></code>,
<code class="docutils literal notranslate"><span class="pre">OPENMP_C</span></code> and <code class="docutils literal notranslate"><span class="pre">OPENMP_LINK</span></code>. If you want to build Flash-X with the
GNU Fortran compiler <code class="docutils literal notranslate"><span class="pre">gfortran</span></code> and the GNU C compiler <code class="docutils literal notranslate"><span class="pre">gcc</span></code> then
your <code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> should contain</p>
<div class="codeseg docutils container">
<p>OPENMP = -fopenmp</p>
</div>
<p>If you want to do something more complicated like build Flash-X with the
Lahey Fortran compiler <code class="docutils literal notranslate"><span class="pre">lf90</span></code> and the GNU C compiler <code class="docutils literal notranslate"><span class="pre">gcc</span></code> then your
<code class="docutils literal notranslate"><span class="pre">Makefile.h</span></code> should contain</p>
<div class="codeseg docutils container">
<p>OPENMP_FORTRAN = –openmp -Kpureomp OPENMP_C = -fopenmp OPENMP_LINK =
–openmp -Kpureomp</p>
</div>
<p>When you run the hybrid Flash-X application it will print the level of
thread support provided by the MPI library and the number of OpenMP
threads in each parallel region</p>
<div class="codeseg docutils container">
<p>: Called MPI_Init_thread - requested level 2, given level 2
[Driver_initParallel]: Number of OpenMP threads in each parallel
region 4</p>
</div>
<p>Note that the Flash-X application will still run if the MPI library does
not provide the requested level of thread support, but will print a
warning message alerting you to an unsafe level of MPI thread support.
There is no guarantee that the program will work! I strongly recommend
that you stop using this Flash-X application - you should build a MPI-2
library with thread support and then rebuild Flash-X.</p>
<p>We record extra version and runtime information in the Flash-X log file
for a threaded application.</p>
<p>You should not setup a Flash-X application with both <code class="docutils literal notranslate"><span class="pre">threadBlockList</span></code>
and <code class="docutils literal notranslate"><span class="pre">threadWithinBlock</span></code> equal to <code class="docutils literal notranslate"><span class="pre">True</span></code> - nested OpenMP parallelism
is not supported. For further information about Flash-X multithreaded
applications please refer to Chapter
<a class="reference external" href="#Chp:Multithreaded|flashx|">[Chp:Multithreaded|flashx|]</a>.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id23" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">1</a><span class="fn-bracket">]</span></span>
<p>if a machine has multiple hostnames, setup tries them all</p>
</aside>
<aside class="footnote brackets" id="id24" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">2</a><span class="fn-bracket">]</span></span>
<p>All non-integral values not equal to True/False/Yes/No/On/Off are
considered to be string values</p>
</aside>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="arch.html" class="btn btn-neutral float-left" title="Overview of Flash-X architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="driver.html" class="btn btn-neutral float-right" title="Driver Unit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Flash-X Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>