<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Unit &mdash; Flash-X 0.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Infrastructure" href="infrastructure.html" />
    <link rel="prev" title="The Flash-X configuration" href="setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Flash-X
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="disclaimers.html">Current Status and Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.html">Overview of Flash-X architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">The Flash-X configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Driver Unit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#driver-routines">Driver Routines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#driver-initall"><em>Driver_initAll</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#driver-evolveall"><em>Driver_evolveAll</em></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#runtime-parameters">Runtime Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#driver-finalizeall">Driver_finalizeAll</a></li>
<li class="toctree-l3"><a class="reference internal" href="#driver-accessor-functions">Driver accessor functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-step-limiting">Time Step Limiting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generic-time-step-limiting-for-positive-definiteness">Generic time step limiting for positive definiteness</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="physics.html">Physics Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor.html">Monitor Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Flash-X</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Driver Unit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/driver.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="driver-unit">
<span id="chp-driver-unit"></span><h1>Driver Unit<a class="headerlink" href="#driver-unit" title="Permalink to this heading"></a></h1>
<p>The <em>Driver</em> unit controls the initialization and evolution of Flash-X
simulations. In addition, at the highest level, the Driver unit
organizes the interaction between units. Initialization can be from
scratch or from a stored checkpoint file. It also implements methods
for advancing the solution, and calls the <em>IO</em> unit at the end of
every timestep to produce checkpoint files, plot files, or other output.</p>
<section id="driver-routines">
<span id="id1"></span><h2>Driver Routines<a class="headerlink" href="#driver-routines" title="Permalink to this heading"></a></h2>
<p>The most important routines in the <em>Driver</em> API are those that
initialize, evolve, and finalize the Flash-X program. The file
<em>main.F90</em> contains the main Flash-X program (equivalent to
<em>main()</em> in C). The default top-level program of Flash-X,
<em>Simulation/main.F90</em>, calls <em>Driver</em> routines in this order:</p>
<div class="codeseg docutils container">
<p>program Flashx</p>
<p>implicit none</p>
<p>call Driver_initParallel()</p>
<p>call Driver_initAll()</p>
<p>call Driver_evolveAll( )</p>
<p>call Driver_finalizeAll( )</p>
<p>end program Flashx</p>
</div>
<p>Therefore the no-operation stubs for these routines in the Driver
source directory must be overridden by an implementation function in a
unit implementation directory under the Driver or <em>Simulation</em>
directory trees, in order for a simulation to perform any meaningful
actions. The most commonly used implementations for these files
are located in the <em>Driver/DriverMain</em> unit implementation directory,
with a few specialized ones in
<em>Driver/DriverMain/Unsplit</em>.</p>
<section id="driver-initall">
<h3><em>Driver_initAll</em><a class="headerlink" href="#driver-initall" title="Permalink to this heading"></a></h3>
<p>The first of these routines is <em>Driver/Driver_initParallel</em>, which
initializes the parallel environment for the simulation. New in Flash-X
is an ability to replicate the mesh where more than one copy of the
discretized mesh may exist with some overlapping and some
non-overlapping variables. Because of this feature, the parallel
environment differentiates between global and mesh communicators. All
the necessary communicators, and the attendant meta-data is generated in
this routine. Also because of this modification, runtime parameters such
as iProcs, jProcs etc, which were under the control of the Grid unit in
Flash-X, are now under the control of the Driver unit. Several new
accessor interface allow other code units to query the driver unit for
this information. The <em>Driver/Driver_initAll</em>, the next routine, in
general calls the initialization routines in each of the units. If a
unit is not included in a simulation, its stub (or empty) implementation
is called. Having stub implementations is very useful in the Driver
unit because it allows the user to avoid writing a new driver for each
simulation. For a more detailed explanation of stub implementations
please see . It is important to note that when individual units are
being initialized, order is often very important and the order of
initialization is different depending on whether the run is from scratch
or being restarted from a checkpoint file.</p>
</section>
<section id="driver-evolveall">
<h3><em>Driver_evolveAll</em><a class="headerlink" href="#driver-evolveall" title="Permalink to this heading"></a></h3>
<p>The next routine is <em>Driver/Driver_evolveAll</em> which controls the
timestepping of the simulation, as well as the normal termination of
Flash-X based on time. Driver_evolveAll checks the parameters
<em>tmax</em>, <em>nend</em> to determine that the run should end,
having reached a particular point in time, a certain number of steps, or
a particular cosmological redshift, respectively. Likewise the initial
simulation time, step number and cosmological redshift for a simulation
can be set using the runtime parameters <em>tmin</em>, <em>nbegin</em>.</p>
<p>The implementation in the Driver/DriverMain/Unsplit directory
is the default. This implementation in general calls each
of the physics routines only once per time step, and each call advances
solution vectors by one timestep. At the end of one loop of timestep
advancement, the condition for updating the adaptive mesh refinement
pattern is tested and applied.</p>
<section id="runtime-parameters">
<h4>Runtime Parameters<a class="headerlink" href="#runtime-parameters" title="Permalink to this heading"></a></h4>
<p>The Driver unit supplies certain runtime parameters regardless of
which type of driver is chosen. These are described in the online
Driver/Runtime Parameters Documentation page.</p>
</section>
</section>
<section id="driver-finalizeall">
<h3>Driver_finalizeAll<a class="headerlink" href="#driver-finalizeall" title="Permalink to this heading"></a></h3>
<p>Finally, the the Driver unit calls <em>Driver/Driver_finalizeAll</em>
which calls the finalize routines for each unit. Typically this involves
deallocating memory and any other necessary cleanup.</p>
</section>
<section id="driver-accessor-functions">
<h3>Driver accessor functions<a class="headerlink" href="#driver-accessor-functions" title="Permalink to this heading"></a></h3>
<p>Driver unit also provides a number of accessor
functions to get data stored in the Driver unit, for example
<em>Driver/Driver_getDt</em>, <em>Driver/Driver_getNStep</em>,
<em>Driver/Driver_getElapsedWCTime</em>, <em>Driver/Driver_getSimTime</em>.</p>
<p>The Driver unit API also defines two interfaces for halting the
code, <em>Driver/Driver_abort</em> and
<em>Driver/Driver_abortC</em> .c. The ’c ’ routine version
is available for calls written in C, so that the user does not have to
worry about any name mangling. Both of these routines print an error
message and call <em>MPI_Abort</em>.</p>
</section>
<section id="time-step-limiting">
<h3>Time Step Limiting<a class="headerlink" href="#time-step-limiting" title="Permalink to this heading"></a></h3>
<p>The Driver unit is responsible for determining the time step
<span class="math notranslate nohighlight">\(\Delta t\)</span> that is used to advance the solution from time
<span class="math notranslate nohighlight">\(t=t^{n-1}\)</span> to <span class="math notranslate nohighlight">\(t^n\)</span>. At startup, a tentative
<span class="math notranslate nohighlight">\(\Delta t\)</span> is chosen based in runtime parameters, in particular
<em>Driver/dtinit</em>. The routine <em>Driver/Driver_verifyInitDt</em> (usually
invoked from Driver/Driver_initAll) is used to check and, if
necessary, modify the initial <span class="math notranslate nohighlight">\(\Delta t\)</span>. Subsequently, the
routine <em>Driver/Driver_computeDt</em> (usually invoked from
Driver/Driver_evolveAll <em>at the end</em> of an iteration of the main
evolution loop) is used to recompute <span class="math notranslate nohighlight">\(\Delta t\)</span> for the next
evolution step.</p>
<p>The implementation of Driver/Driver_computeDt can lower or increase
the time step. It takes various runtime parameters into consideration,
including <em>Driver/dtmin</em>, <em>Driver/dtmax</em>, and
<em>Driver/tstep_change_factor</em>. For the most part, however,
Driver/Driver_computeDt calls on <em>UNIT_computeDt</em> routines of
various code units to query those units for their time step
requirements, and usually chooses the smallest time step that is
acceptable to all units queried.</p>
<p>The code units that participate in this negotiation return a
<span class="math notranslate nohighlight">\(\Delta t\)</span>, and usually some additional information about which
location in the simulaton domain caused the reequired step to be as low
as returned. A unit’s time step requirement can depend on the current
state of the solution as well as on further runtime parameters. For
example, the dt returned by <em>physics/Hydro/Hydro_computeDt</em>
depends on the state of density, pressure, and velocities (and possibly
additional variables) in the cells of the domain, as well as on the
runtime parameter <em>Hydro/cfl</em>.</p>
<section id="generic-time-step-limiting-for-positive-definiteness">
<span id="sec-dr-posdef"></span><h4>Generic time step limiting for positive definiteness<a class="headerlink" href="#generic-time-step-limiting-for-positive-definiteness" title="Permalink to this heading"></a></h4>
<p>A generic method for limiting time steps, based on a requirement that
certain (user-specified) variables should never become negative, has
been added in Flash-X. To understand the basic idea, think of each
variable that this limiter is applied to as a density of some quantity
<span class="math notranslate nohighlight">\(q\)</span>. (Variables of PER_MASS type are actually converted to
their PER_VOLUME counterparts in the implementation of the method.)</p>
<p>The algorithm is based on examining the distribution of <span class="math notranslate nohighlight">\(q\)</span> in
neighboring cells, and making for each cell a near-worst-case estimate
of the rate of depletion <span class="math notranslate nohighlight">\(\dot q\)</span> based on projected fluxes of
<span class="math notranslate nohighlight">\(q\)</span> out of the cell over its faces. This can be applied to any
variable, it is not required that the variable represents any quantity
that is actually advected as described. See for how to use. This feature
may be particularly useful when applied to “eion” in
multidimensional 3T simulations in order to avoid some kinds of
“negative ion temperature” failures, as an alternative to lowering the
<em>Hydro</em> runtime parameter <em>Hydro/cfl</em>.</p>
<div class="center docutils container">
<div class="docutils container" id="tab-dr-posdef-parameters">
</div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup.html" class="btn btn-neutral float-left" title="The Flash-X configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="infrastructure.html" class="btn btn-neutral float-right" title="Infrastructure" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Flash-X Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>