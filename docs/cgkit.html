

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Code Generation Toolkit &mdash; Flash-X 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=7026087e"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Macroprocessor" href="macroprocessor.html" />
    <link rel="prev" title="Overview of ORCHA" href="orcha_overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Flash-X
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="disclaimers.html">Current Status and Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.html">Overview of Flash-X architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="orcha.html">The Performance Portability System</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="orcha_overview.html">Overview of ORCHA</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Code Generation Toolkit</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#patterns">Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="macroprocessor.html">Macroprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="milhoja.html">Milhoja</a></li>
<li class="toctree-l2"><a class="reference internal" href="application_use.html">Application’s Use of Orcha</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">The Flash-X configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeadvance.html">TimeAdvance</a></li>
<li class="toctree-l1"><a class="reference internal" href="infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="physics.html">Physics Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor.html">Monitor Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_section.html">Developer’s Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Flash-X</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="orcha.html">The Performance Portability System</a></li>
      <li class="breadcrumb-item active">Code Generation Toolkit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/cgkit.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="code-generation-toolkit">
<span id="chp-cgkit"></span><h1>Code Generation Toolkit<a class="headerlink" href="#code-generation-toolkit" title="Link to this heading"></a></h1>
<p>The object of CG-Kit is to empower knowledgeable users to be able to
express their desired execution control flow and the map of what to
compute where in a <strong>recipe</strong> without having to change the source
code. Our vision is to provide a shorthand for expressing the needed
variations in implementation that enable
optimization of the application instance as desired.
With CG-Kit the variants can be expressed succinctly in Python
without including any of the data layout and numerical
detail. The recipes are parsed and coverted into graphs which are optimized
for minimizing data movement and maximizing data reuse and potential
for latency hiding. Optimized graphs are then converted to
<strong>parameterized source trees</strong> (PST) that serve the same purpose for code
generation in compilable langagues as abstract
syntax trees (AST) do for compiling a code into an executable.
The ASTs have rich context information that can be utilized
for code transformation without user intervention. In the context of
algorithmic variants, we would like to shift implementation efforts
to controlling code generation tools instead of directly working with
the code. We achieve this by decomposition of source code into templates that are
user-defined blocks of source code. Platform-dependent customizations are encapsulated in
the templates using macros (to be described later). The PSTs are
constructed from these code templates. The final generated code is compilable and optimized for
readability by human programmers, which is a key property to aide
developers with code understanding, debugging, and reasoning about
performance metrics.</p>
<section id="patterns">
<span id="sec-patterns"></span><h2>Patterns<a class="headerlink" href="#patterns" title="Link to this heading"></a></h2>
<p>There are recurring patterns that are recognized by the CG-Kit recipe
interface. These are:</p>
<p>#. <strong>Pipeline</strong> A pipeline expresses the execution order of code generation operations and the
dependencies of operations on one another.  If operations are meant to
be applied to data items (e.g., discretized
spatial/temporal operators of a partial differential equation), then those
data items would flow through the pipeline concurrently; hence, the data items
are assumed to be independent of each other.</p>
<p>#. <strong>Begin-End</strong> A begin-end pattern describes the nesting of code generation operations (and/or
a pipeline of operations) within a construct that has a defined beginning and an
end, for example, a loop or a conditional statement.  The coupling of a pair of
begin-end nodes enables initialization and finalization of code generation tasks
as these nodes are visited in the order of their occurrence in the graph.</p>
<p>#. <strong>Concurrent Data</strong> The concurrent data pattern describes a single operation or a pipeline
of operations executed on independent data items.
This pattern is derived from the begin-end pattern; thus, implementing
the concurrent data pattern involves a pair of begin and end nodes.
The relevance of having this pattern is to enable expressing data parallelism in
a code generation workflow.</p>
<p>The motivation for recipes is to enable users to abstract building blocks
of algorithms to a desired level such that variants can be easily composed
and modified.  The particular level or degree at which an algorithm’s
implementation is abstracted will strongly depend on the algorithm itself.
Therefore, CG-Kit recipes do not make assumptions about the
abstraction, instead, they let the users define the level of desired abstraction.
Recipes follow a <a href="#id1"><span class="problematic" id="id2">``</span></a>define and run’’ principle.  This principle
entails that the recipe writer selects the granulariy of  algorithmic building blocks
(e.g., subroutines, actions, etc.) and defines their dependencies on each other.</p>
</section>
<section id="example">
<span id="sec-example"></span><h2>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h2>
<p>We have applied CG-Kit to generate variants in the new Hydro solver,
Spark, which has two different modes for optimizing memory and
communication optizations. The memory optimizations apply to using
Spark with AMReX, which prefers to apply flux-correction on a per
level basis and allocate and  deallocate memory for storage of fluxes
at that level before going on to the next finer level. Paramesh
applies flux-correction at all levels simultaneously. In principle
this can be done for AMReX too by keeping the flux-storage around
until all levels have finished computing. The communication optimization
at the cost of extra computation and memory applies to multi-stage RK
integration. The <em>telescoping</em> mode of operation gets extra layers of
guardcells and in all except the final stage also updates the cells
that will act as guardcells for the next stage. Thus for a 2 stage RK
we get 2*NGUARD guardcells along each face In the first stage we
update NGUARD extra cells along each face so that no communication is
requered to fetch them from neighboring blocks. The figure below shows
two of these variants.</p>
<div class="center docutils container">
<figure class="align-default" id="fig-variants">
<a class="reference internal image-reference" href="_images/variants.png"><img alt="variants" src="_images/variants.png" style="width: 6.5in;" />
</a>
</figure>
</div>
<p>In these variants the arithmetic of physics computations remains
unchanged, the only difference occur in the control flow of the
algorithm and where communications are placed during
computation. Recipes provide a succint way of expressing these
variants.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="orcha_overview.html" class="btn btn-neutral float-left" title="Overview of ORCHA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="macroprocessor.html" class="btn btn-neutral float-right" title="Macroprocessor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Flash-X Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>