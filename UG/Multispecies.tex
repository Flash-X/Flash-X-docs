\chapter{Multispecies Unit}
\label{Chp:Multispecies Unit}


Flash-X has the ability to track multiple fluids, each of which can have
its own properties.  The \unit{Multi\-species} unit handles setting and querying
on the properties of fluids, as well as some common operations on properties.
The advection and normalization of species is
described in the context of the Hydro unit in \chpref{Chp:Hydrodynamics Unit}.

\section{Defining Species}
\label{Sec:defining_species}

The names and properties of fluids are accessed by using their constant integer values defined
in the \code{Simulation.h} header file.
The species names are defined in a \code{Config} file.
The names of the species, for example \code{AIR}, \code{NI56}, are given in the \code{Config} file with keyword \code{SPECIES}.

In the traditional method for defining species, this \code{Config} would typically be
the application's \code{Config} file in the \unit{Simulation} unit.
In the alternative method described below in \secref{Sec:DefineSpecies2},
\code{SPECIES} are normally not listed explicitly in
the \unit{Simulation} unit \code{Config},
but instead are automatically generated by \code{Multispecies/MultispeciesMain/Config}
based on the contents of the \code{species} setup variable.
Either way, the \code{setup} procedure transforms those names into
accessor integers with the appended description \code{\_SPEC}.

These names are stored in the \code{Simulation.h} file.  The total number of species defined is also defined within \code{Simulation.h} as \code{NSPECIES}, and the integer range of their definition is given by \code{SPECIES\_BEGIN} and \code{SPECIES\_END}.
To access the species in your code, use the index listed in \code{Simulation.h}, for example \code{AIR\_SPEC}, \code{NI56\_SPEC}.

Note that \code{NSPECIES}, \code{SPECIES\_BEGIN}, and \code{SPECIES\_END}
are always defined, whether a simulation uses multiple species or
not (and whehter the simulation includes the \code{Multispecies} unit
or not). However, if \code{NSPECIES}$=0$, 
\code{SPECIES\_END} will be less than \code{SPECIES\_BEGIN}, and
then neither of them should be used as an index into solution vectors.

As an illustration, Figures~\figref{fig:MultispeciesConfig} and
\figref{fig:MultispeciesHeader} are snippets from a configuration file
and the corresponding section of the Flash-X header file, respectively.
 For more information on \code{Config} files, see \secref{Sec:Config};
for more information on the \code{setup} procedure, see
\chpref{Chp:The Flash-X configuration script};
for more information on the structure of the main header file \code{Simulation.h}, see
\chpref{Chp:Simulation.h}.


\begin{figure}
\begin{shrink}
\begin{fcodeseg}
# Portion of a Config file for a Simulation
SPECIES AIR
SPECIES SF6
\end{fcodeseg}
\end{shrink}
\caption{Sample \code{Config} file showing how to define required fluid species.}
\label{fig:MultispeciesConfig}
\end{figure}

\begin{figure}
\begin{shrink}
\begin{fcodeseg}
#define SPECIES_BEGIN (NPROP_VARS + CONSTANT_ONE)
#define AIR_SPEC 11
#define SF6_SPEC 12
#define NSPECIES 2
#define SPECIES_END (SPECIES_BEGIN + NSPECIES - CONSTANT_ONE)
\end{fcodeseg}
\end{shrink}
\caption{Sample excerpt from header file \code{Simulation.h} showing integer definition of fluid species.}
\label{fig:MultispeciesHeader}
\end{figure}


\begin{flashtip}
In \flashx, you found the integer index of a species by using \code{find\_fluid\_index}.  In \flashx, the
species index is always available because it is defined in \code{Simulation.h}.  Use the index directory, as in
\code{xIn(NAME\_SPEC - SPECIES_BEGIN + 1) = solnData(NAME\_SPEC,i,j,k)}.

But be careful that the species name is really defined in your simulation!  You can test with
\begin{codeseg}
if (NAME_SPEC /= NONEXISTENT) then
    okVariable = solnData(NAME_SPEC,i,j,k)
endif
\end{codeseg}
\end{flashtip}


The available properties of an individual fluid are listed in
\tblref{Tbl:MultispeciesProperties}
and are defined in file \code{Multi\-species.h}.  
In order to reference the properties in code, you must \code{\#include} the file \code{Multispecies.h}.
The initialization of properties is described in the following section.

\begin{table}
\begin{center}
\caption{Properties available through the \unit{Multispecies} unit.}
\label{Tbl:MultispeciesProperties}
\begin{tabular}{l p{2.7in} l}
{\bf Property Name} & {\bf Description} & {\bf Data type} \\
\hline
\code{A}                & Number of protons and neutrons in nucleus      & real           \\
\code{Z}                & Atomic number                                  & real           \\
\code{N}                & Number of neutrons                             & real           \\
\code{E}                & Number of electrons                            & real           \\
\code{BE}               & Binding Energy                                 & real           \\
\code{GAMMA}            & Ratio of heat capacities                       & real           \\
\code{MS\_ZMIN}         & Minimum allowed average ionization             & real           \\
\code{MS\_EOSTYPE}      & EOS type to use for MTMMMT EOS                 & integer        \\
\code{MS\_EOSSUBTYPE}   & EOS subtype to use for MTMMMT EOS              & integer        \\
\code{MS\_EOSZFREEFILE} & Name of file with ionization data              & string         \\
\code{MS\_EOSENERFILE}  & Name of file with internal energy data         & string         \\
\code{MS\_EOSPRESFILE}  & Name of file with pressure data                & string         \\
\code{MS\_NUMELEMS}     & Number of elements comprising this species     & integer        \\
\code{MS\_ZELEMS}       & Atomic number of each species element          & array(integer) \\
\code{MS\_AELEMS}       & Mass number of each species element            & array(real)    \\
\code{MS\_FRACTIONS}    & Number fraction of each species element        & array(real)    \\
\code{MS\_OPLOWTEMP}    & Temperature at which cold opacities are used   & real           \\
\hline
\end{tabular}
\end{center}
\end{table}


\section{Initializing Species Information in \code{Simulation_initSpecies}}
\label{Sec:init_species}
Before you can work with the properties of a fluid, you must
initialize the data in the \code{Multi\-species} unit.  Normally,
initialization is done in the routine
\api{Simulation/Simulation_initSpecies}.  An example procedure is
shown below and consists of setting relevant properties for all
fluids/\code{SPECIES} defined in the \code{Config} file.  Fluids do not have to be isotopes; any molecular
substance which can be defined by the properties shown in
\figref{Fig:MultispeciesInit} is a valid input to the
Multispecies unit.

\begin{figure}
 \begin{shrink}
  \begin{codeseg}
  subroutine Simulation_initSpecies()

implicit none
#include "Multispecies.h"
#include "Simulation.h"

! These two variables are defined in the Config file as
! SPECIES SF6 and SPECIES AIR
  call Multispecies_setProperty(SF6_SPEC, A, 146.)
  call Multispecies_setProperty(SF6_SPEC, Z, 70.)
  call Multispecies_setProperty(SF6_SPEC, GAMMA, 1.09)

  call Multispecies_setProperty(AIR_SPEC, A, 28.66)
  call Multispecies_setProperty(AIR_SPEC, Z, 14.)
  call Multispecies_setProperty(AIR_SPEC, GAMMA, 1.4)
end subroutine Simulation_initSpecies
\end{codeseg}
\end{shrink}
\caption{A \code{Simulation\_initSpecies.F90} file showing Multispecies initialization}
\label{Fig:MultispeciesInit}
\end{figure}


\begin{flashtip}
For nuclear burning networks, a \code{Simulation\_initSpecies} routine is already predefined.  It automatically initializes all isotopes found in the \code{Config} file.  To use this shortcut, \code{REQUIRE} the module \code{Simulation/SimulationComposition} in the \code{Config} file.
\end{flashtip}

\section{Specifying Constituent Elements of a Species}
\label{Sec:constelems}

A species can represent a specific isotope or a single element or a more complex material. Some
units in Flash-X require information about the elements that constitute
a single species. For example, water is comprised of two elements:
Hydrogen and Oxygen. The \code{Multispecies} database can store a list
of the atomic numbers, mass numbers, and relative number fractions of
each of the elements within a given species. This information is
stored in the array properties \code{MS\_ZELEMS}, \code{MS\_AELEMS},
and \code{MS\_FRACTIONS} respectively. The property
\code{MS\_NUMELEMS} contains the total number of elements for a
species (\code{MS\_NUMELEMS} would be two for water since water is
made of Hydrogen and Oxygen). There is an upper bound on the number of
elements for a single species which is defined using the preprocessor
symbol \code{MS\_MAXELEMS} in the ``Simulation.h'' header file and defaults
to six. The value of \code{MS\_MAXELEMS} can be changed using the
\code{ms\_maxelems} setup variable. \figref{Fig:MultispeciesElems} shows
an example of how the constituent elements for water can be set using
the \code{Simulation\_initSpecies} subroutine.

The constituent element information is optional and is only needed if
a particular unit of interest requires it. At present, only the
analytic cold opacities used in the \code{Opacity} unit make use of
the constituent element information.

\begin{figure}
\begin{shrink}
\begin{codeseg}
#include "Simulation.h"
#include "Multispecies.h"

! Create arrays to store constituent element data. Note that these
! arrays are always of length MS_MAXELEMS.
real :: aelems(MS_MAXELEMS)
real :: fractions(MS_MAXELEMS)
integer :: zelems(MS_MAXELEMS)

call Multispecies_setProperty(H2O_SPEC, A, 18.0/3.0) ! Set average mass number
call Multispecies_setProperty(H2O_SPEC, Z, 10.0/3.0) ! Set average atomic number
call Multispecies_setProperty(H2O_SPEC, GAMMA, 5.0/3.0)
call Multispecies_setProperty(H2O_SPEC, MS_NUMELEMS, 2)

aelems(1) =  1.0 ! Hydrogen
aelems(2) = 16.0 ! Oxygen
call Multispecies_setProperty(H2O_SPEC, MS_AELEMS, aelems)

zelems(1) = 1 ! Hydrogen
zelems(2) = 8 ! Oxygen
call Multispecies_setProperty(H2O_SPEC, MS_ZELEMS, zelems)  

fractions(1) = 2.0/3.0 ! Two parts Hydrogen
fractions(2) = 1.0/3.0 ! One part Oxygen
call Multispecies_setProperty(H2O_SPEC, MS_FRACTIONS, fractions)
\end{codeseg}
\end{shrink}
\caption{A \code{Simulation\_initSpecies.F90} file showing Multispecies initialization}
\label{Fig:MultispeciesElems}
\end{figure}


\section{Alternative Method for Defining Species}
\label{Sec:DefineSpecies2}

\secref{Sec:defining_species} described how species can be defined by
using the \code{SPECIES} keyword in the \code{Config}
file. \secref{Sec:init_species} then described how the properties of
the species can be set using various subroutines defined in the
\code{Multispecies} unit. There is an alternative to these approaches
which uses setup variables to define the species, then uses runtime
parameters to set the properties of each species. This allows users to
change the number and names of species without modifying the
\code{Config} file and also allows users to change properties without
recompiling the code.

Species can be defined using the \code{species} setup variable. For
example, to create two species called \code{AIR} and \code{SF6} one
would specify \code{species=air,sf6} in the simulation setup
command. Using this setup variable and using the \code{SPECIES}
keyword in the \code{Config} file are mutually exclusive. Thus, the
user must choose which method they wish to use for a given
simulation. Certain units, such as the \code{Opacity} unit, requires
the use of the setup variable.

When species are defined using the setup variable approach, the
\code{Multispecies} unit will automatically define several runtime
parameters for each species. These runtime parameters can be used set
the properties shown in \tblref{Tbl:MultispeciesProperties}. The
runtime parameter names contain the species
name. \tblref{Tbl:MultispeciesRtp} shows an example of the mapping
between runtime parameters and \code{Multispecies} properties, where
\code{<spec>} is replaced by the species name as specified in the
species setup argument list. Some of these runtime parameters are
arrays, and thus the \code{<N>} is a number ranging from 1 to
\code{MS\_MAXELEMS}. The \code{Simulation\_initSpecies} subroutine can
be used to override the runtime parameter settings.

\begin{table}
\begin{center}
\caption{Automatically Generated \code{Multispecies} Runtime Parameters}
\label{Tbl:MultispeciesRtp}
\begin{tabular}{l l}
{\bf Property Name} & {\bf Runtime Parameter Name}         \\
\hline
\code{A}                &  \code{ms\_<spec>A}              \\
\code{Z}                &  \code{ms\_<spec>Z}              \\
\code{N}                &  \code{ms\_<spec>Neutral}        \\
\code{E}                &  \code{ms\_<spec>Negative}       \\
\code{BE}               &  \code{ms\_<spec>BindEnergy}     \\
\code{GAMMA}            &  \code{ms\_<spec>Gamma}          \\
\code{MS\_ZMIN}         &  \code{ms\_<spec>Zmin}           \\
\code{MS\_EOSTYPE}      &  \code{eos\_<spec>EosType}       \\
\code{MS\_EOSSUBTYPE}   &  \code{eos\_<spec>SubType}       \\
\code{MS\_EOSZFREEFILE} &  \code{eos\_<spec>TableFile}     \\
\code{MS\_EOSENERFILE}  &  \code{eos\_<spec>TableFile}     \\
\code{MS\_EOSPRESFILE}  &  \code{eos\_<spec>TableFile}     \\
\code{MS\_NUMELEMS}     &  \code{ms\_<spec>NumElems}       \\
\code{MS\_ZELEMS}       &  \code{ms\_<spec>ZElems\_<N>}    \\
\code{MS\_AELEMS}       &  \code{ms\_<spec>AElems\_<N>}    \\
\code{MS\_FRACTIONS}    &  \code{ms\_<spec>Fractions\_<N>} \\
\code{MS\_OPLOWTEMP}    &  \code{op\_<spec>LowTemp}        \\
\hline
\end{tabular}
\end{center}
\end{table}           

\section{Routine Descriptions}
We now briefly discuss some interfaces to the multifluid
database that are likely of interest to the user.
Many of these routines
include optional arguments.

\begin{itemize}

\item \api{Multispecies/Multispecies_setProperty}
This routine sets the value species property.  It should be called within the subroutine
\api{Simulation/Simulation_initSpecies} for all the species of interest in the
simulation problem, and for all the required properties (any of A, Z, N, E, EB, GAMMA).
\begin{flashtip}
In \flashx, you could set multiple properties at once in a call to \code{add\_fluid\_to\_db}.
In \flashx, individual calls are required.  If you are setting up a nuclear network, there
is a precoded \api{Simulation/Simulation_initSpecies} to easily initialize all necessary species.
It is located in the unit \code{Simulation/SimulationComposition},
which must be listed in your simulation \code{Config} file.
\end{flashtip}

\item \api{Multispecies/Multispecies_getProperty}
Returns the value of a requested property.

\item \api{Multispecies/Multispecies_getSum}
Returns a weighted sum of a chosen property of species.
The total number of species can be subset.
The weights are optional, but are typically the mass
fractions $X_i$ of each of the fluids at a point in space.
In that case, if the selected property
(one of
$A_i$, $Z_i$, \ldots, $\gamma_i$)
is denoted ${\cal{P}}_i$,
the sum calculated is
\[
\sum_i {X_i}{\mathcal{P}_i} \quad.
\]

\item \frenchspacing \api{Multispecies/Multispecies_getAvg}
Returns
the weighted average of the chosen property. As in
\code{Multi\-species\_get\-Sum}, weights are optional and a subset of species can be chosen.
If the weights are denoted $w_i$
and the selected property
(one of
$A_i$, $Z_i$, \ldots, $\gamma_i$)
is denoted ${\cal{P}}_i$,
the average calculated is
\[
\frac{1}{N} \sum_i^N {w_i}{\mathcal{P}_i} \quad,
\]
where $N$ is the number of species included in the sum; it may be less than the number of all
defined species
if an average over a subset is requested.

\item \api{Multispecies/Multispecies_getSumInv}
Same as \code{Multispecies\_getSum}, but compute
the weighted sum of the inverse of the chosen property.
If the weights are denoted $w_i$
and the selected property
(one of
$A_i$, $Z_i$, \ldots, $\gamma_i$)
is denoted ${\cal{P}}_i$,
the sum calculated is
\[
\sum_i^N \frac{w_i}{\mathcal{P}_i} \quad.
\]


For example, the average atomic mass of a collection of fluids is typically
defined by
\begin{equation}
\frac{1}{\bar{A}} = \sum_i \frac{X_i}{A_i}~,
\end{equation}
where $X_i$ is the mass fraction of species $i$, and $A_i$ is the
atomic mass of that species.  To compute $\bar{A}$ using the multifluid
database, one would use the following lines
\begin{codeseg}
      call Multispecies_getSumInv(A, abarinv, xn(:))
      abar = 1.e0 / abarinv
\end{codeseg}
where \code{xn(:)} is an array of the mass fractions of each species in Flash-X.
This method allows some of the mass fractions to be zero.

\item \api{Multispecies/Multispecies_getSumFrac}
Same as \code{Multispecies\_getSum}, but compute the weighted sum of
the chosen property divided by the total number of particles ($A_i$).
If the weights give the mass
fractions $X_i$ of the fluids at a point in space
and the selected property
(one of
$A_i$, $Z_i$, \ldots, $\gamma_i$)
is denoted ${\cal{P}}_i$,
the sum calculated is
\[
\sum_i \frac{X_i}{A_i}{\mathcal{P}_i} \quad.
\]

\item \api{Multispecies/Multispecies_getSumSqr}
Same as \code{Multispecies\_getSum}, but compute the weighted sum of
the squares of the chosen property values.
If the weights are denoted $w_i$
and the selected property
(one of
$A_i$, $Z_i$, \ldots, $\gamma_i$)
is denoted ${\cal{P}}_i$,
the sum calculated is
\[
\sum_i^N {w_i}{\mathcal{P}_i}^2 \quad.
\]


\item \api{Multispecies/Multispecies_list}
List the contents of the multifluid database in a snappy table format.

\end{itemize}


\section{Example Usage}

In general, to use Multispecies properties in a simulation,
the user must only properly initialize the species as described above in the
\code{Simulation_init} routine.
But to program with the Multispecies properties, you 
must do three things:
\begin{itemize}
\item \code{\#include} the \code{Simulation.h} file to identify the defined species 
\item \code{\#include} the \code{Multispecies.h} file to identify the desired property
\item use the Fortran interface to the Multispecies unit because the majority of
the routines are overloaded.
\end{itemize}
The example below shows a snippet of code to calculate the electron density.
\begin{codeseg}
...
#include Simulation.h
#include Multispecies.h

    USE Multispecies_interface, ONLY:  Multispecies_getSumInv, Multispecies_getSumFrac
...
    do k=blkLimitsGC(LOW,KAXIS),blkLimitsGC(HIGH,KAXIS)
        do j=blkLimitsGC(LOW,JAXIS),blkLimitsGC(HIGH,JAXIS)
           do i=blkLimitsGC(LOW,IAXIS),blkLimitsGC(HIGH,IAXIS)
              call Multispecies_getSumInv(A,abar_inv)
              abar = 1.e0 / abar_inv
              call Multispecies_getSumFrac(Z,zbar)
              zbar = abar * zbar
              ye(i,j,k) = abar_inv*zbar
           enddo
        enddo
     enddo
...
\end{codeseg}

\section{Unit Test}
\label{Sec:MultispeciesUnitTest}
The unit test for \code{Multispecies} provides a complete example of how to call the
various API routines in the unit with all variations of arguments.  Within 
\api{Multispecies/Multispecies_unitTest}, incorrect usage is also
indicated within commented-out statements.
